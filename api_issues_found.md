# APIå‹•ä½œå•é¡Œãƒ¬ãƒãƒ¼ãƒˆ

## ç™ºè¦‹æ—¥æ™‚
2025å¹´7æœˆ21æ—¥ 09:30

## èªè¨¼API (/login) ã®å•é¡Œ

### å•é¡Œ1: ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ ã®ä¸ä¸€è‡´
**æœŸå¾…å€¤ï¼ˆãƒ†ã‚¹ãƒˆï¼‰**: 
```json
{
  "success": true,
  "user_id": "test_user", 
  "user_name": "Test User"
}
```

**å®Ÿéš›ã®APIå®Ÿè£…**:
```json
{
  "message": "ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ",
  "user": {
    "user_id": "test_user",
    "user_name": "Test User"
  }
}
```

**å½±éŸ¿**: ãƒ†ã‚¹ãƒˆãŒå®Ÿéš›ã®APIãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ ã¨ä¸€è‡´ã—ã¦ã„ãªã„

### å•é¡Œ2: ã‚µãƒ¼ãƒ“ã‚¹å®Ÿè£…ã¨APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è©³ç´°
**UserService.authenticate_user**: `Optional[Dict[str, Any]]` ã‚’è¿”ã™
- æˆåŠŸæ™‚: `{"user_id": "test_user", "user_name": "Test User", "role": "USER"}`
- å¤±æ•—æ™‚: `None`

**APIå®Ÿè£…**: 
```python
if user:
    request.session["user"] = user
    return {"message": "ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ", "user": user}
else:
    raise HTTPException(status_code=401, detail="ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒç„¡åŠ¹ã§ã™")
```

**å•é¡Œ**: ãƒ†ã‚¹ãƒˆã¯ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ãƒ™ãƒ«ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã‚’æœŸå¾…ã—ã¦ã„ã‚‹ãŒã€å®Ÿéš›ã®APIã¯ç•°ãªã‚‹æ§‹é€ ã‚’è¿”ã™

### å•é¡Œ3: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®è¤‡é›‘æ€§
**APIå®Ÿè£…**: `request.session["user"] = user` ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜
**ãƒ†ã‚¹ãƒˆ**: ã‚»ãƒƒã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã®ãƒ¢ãƒƒã‚¯åŒ–ãŒä¸å®Œå…¨

### å•é¡Œ4: ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³APIã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸æ•´åˆ
**ç™ºè¦‹ç®‡æ‰€**: `/admin/login`

**ãƒ†ã‚¹ãƒˆã§é€ä¿¡**:
```json
{"user_id": "admin_user"}
```

**APIå®Ÿè£…ã§è¦æ±‚**:
```json
{"user_id": "admin_user", "password": "required_field"}
```

**ã‚¨ãƒ©ãƒ¼**: `422 Unprocessable Entity` - Field required: password
**å½±éŸ¿**: ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ãŒå…¨ã¦å¤±æ•—

### å•é¡Œ5: æœªå®Ÿè£…ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
**ç™ºè¦‹ç®‡æ‰€**: `/refresh`, `/user/info`

**ã‚¨ãƒ©ãƒ¼**: `404 Not Found`
**å•é¡Œ**: ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„ã‹ã€å®Ÿè£…ãŒä¸å®Œå…¨

### å•é¡Œ6: TestClientã‚»ãƒƒã‚·ãƒ§ãƒ³å‡¦ç†å•é¡Œ
**ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼**: `'TestClient' object has no attribute 'session_transaction'`
**å•é¡Œ**: Flaskã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å‡¦ç†æ–¹æ³•ãŒFastAPIã®TestClientã§ä½¿ç”¨ã§ããªã„

## ä¿®æ­£ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
1. ãƒ†ã‚¹ãƒˆã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹æœŸå¾…å€¤ã‚’APIå®Ÿè£…ã«åˆã‚ã›ã‚‹
2. ã‚µãƒ¼ãƒ“ã‚¹ãƒ¢ãƒƒã‚¯ã®æˆ»ã‚Šå€¤ã‚’å®Ÿéš›ã®å‹ã«åˆã‚ã›ã‚‹  
3. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®ãƒ¢ãƒƒã‚¯åŒ–ã‚’æ”¹å–„

## ãƒ­ã‚°ã‚¢ã‚¦ãƒˆAPI (/logout) ã®å•é¡Œ

### å•é¡Œ1: ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¾å­˜å‡¦ç†
**APIå®Ÿè£…**:
```python
@router.post("/logout")
async def logout(request: Request):
    user = request.session.get("user")
    request.session.clear()
    return {"message": "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"}
```

**å•é¡Œ**: 
- ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…å®¹ã«ä¾å­˜ã™ã‚‹å‡¦ç†
- ãƒ†ã‚¹ãƒˆã§ã¯å®Ÿéš›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æ©Ÿèƒ½ãŒå‹•ä½œã—ãªã„
- `user.get('user_id')` ã§userãŒNoneã®å ´åˆã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§

### å•é¡Œ2: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã®ä¾å­˜é–¢ä¿‚
ãƒ†ã‚¹ãƒˆã®ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ã§è¤‡æ•°ã®ã‚µãƒ¼ãƒ“ã‚¹ã®ä¾å­˜æ€§æ³¨å…¥ãŒå¿…è¦

## ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿API (/metadata/*) ã®å•é¡Œ

### å•é¡Œ1: ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ¬ å¦‚
**ç™ºè¦‹ç®‡æ‰€**: `/metadata/schemas`, `/metadata/schemas/{schema}/tables/{table}/columns`

**ç¾åœ¨ã®APIå®Ÿè£…**:
```python
@router.get("/metadata/schemas", response_model=List[Dict[str, Any]])
async def get_schemas_endpoint(metadata_service: MetadataServiceDep):
    """ã‚¹ã‚­ãƒ¼ãƒä¸€è¦§ã‚’å–å¾—ã™ã‚‹"""
    return await run_in_threadpool(metadata_service.get_schemas)

@router.get("/metadata/schemas/{schema_name}/tables/{table_name}/columns", response_model=List[Dict[str, Any]])
async def get_columns_endpoint(schema_name: str, table_name: str, metadata_service: MetadataServiceDep):
    """ã‚«ãƒ©ãƒ ä¸€è¦§ã‚’å–å¾—ã™ã‚‹"""
    return await run_in_threadpool(metadata_service.get_columns, schema_name, table_name)
```

**å•é¡Œ**: 
- ã‚µãƒ¼ãƒ“ã‚¹å±¤ã§ä¾‹å¤–ãŒç™ºç”Ÿã—ãŸå ´åˆã€é©åˆ‡ã«ã‚­ãƒ£ãƒƒãƒã•ã‚Œã¦ã„ãªã„
- ä¾‹å¤–ãŒãã®ã¾ã¾ä¸Šä½ã«ä¼æ’­ã—ã€500 Internal Server Errorã«ãªã‚‹
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé©åˆ‡ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¦ã„ãªã„
- ãƒ‡ãƒãƒƒã‚°ãŒå›°é›£

**ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹é•å**:
```python
# æ¨å¥¨ã•ã‚Œã‚‹ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä¾‹
@router.get("/metadata/schemas")
async def get_schemas_endpoint(metadata_service: MetadataServiceDep):
    try:
        return await run_in_threadpool(metadata_service.get_schemas)
    except MetadataError as e:
        raise HTTPException(status_code=400, detail=str(e))
    except Exception as e:
        logger.error(f"äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼: {e}")
        raise HTTPException(status_code=500, detail="ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ")
```

**å½±éŸ¿**:
- æœ¬ç•ªç’°å¢ƒã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¸é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹å¯èƒ½æ€§
- ãƒ­ã‚°ãŒé©åˆ‡ã«è¨˜éŒ²ã•ã‚Œãªã„
- ã‚¨ãƒ©ãƒ¼ã®åŸå› ç‰¹å®šãŒå›°é›£

### å•é¡Œ2: ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã®éä¸€è²«æ€§
**ç¾çŠ¶**: FastAPIã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«ä¾å­˜
**å•é¡Œ**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã§ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ãŒçµ±ä¸€ã•ã‚Œã¦ã„ãªã„

## ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆAPI (/export/*) ã®å•é¡Œ

### å•é¡Œ1: Content-Typeé‡è¤‡å•é¡Œ
**ç™ºè¦‹ç®‡æ‰€**: CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½

**ç¾åœ¨ã®å•é¡Œ**:
```
å®Ÿéš›ã®å‡ºåŠ›: "text/csv; charset=utf-8; charset=utf-8"
æœŸå¾…å€¤: "text/csv; charset=utf-8"
```

**åŸå› **: HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆæ™‚ã«charsetãŒé‡è¤‡ã—ã¦è¨­å®šã•ã‚Œã¦ã„ã‚‹
**å½±éŸ¿**: ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚ˆã£ã¦ã¯Content-Typeã®è§£é‡ˆã«å•é¡ŒãŒç”Ÿã˜ã‚‹å¯èƒ½æ€§

### å•é¡Œ2: ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ä¾‹å¤–å‡¦ç†ã®ä¸å‚™
**ç™ºè¦‹ç®‡æ‰€**: CSVç”Ÿæˆã§ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹

**ã‚¨ãƒ©ãƒ¼å†…å®¹**: 
```
RuntimeError: Caught handled exception, but response already started.
```

**å•é¡Œ**: 
- ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°é–‹å§‹å¾Œã®ä¾‹å¤–å‡¦ç†ãŒé©åˆ‡ã§ãªã„
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼é€ä¿¡å¾Œã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã¨é©åˆ‡ã«å‡¦ç†ã§ããªã„
- Mockã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒiterableã§ãªã„å•é¡Œ (`'Mock' object is not iterable`)

**ä¿®æ­£ãŒå¿…è¦ãªç®‡æ‰€**:
```python
# app/api/routes.py ã®CSVã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†
# cursor.description ã®å–ã‚Šæ‰±ã„ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
```

## ãƒ­ã‚°API (/logs/*) ã®å•é¡Œ

### å•é¡Œ1: Pydanticãƒ¢ãƒ‡ãƒ«å‹å®šç¾©ã‚¨ãƒ©ãƒ¼
**ç™ºè¦‹ç®‡æ‰€**: SQLExecutionLogãƒ¢ãƒ‡ãƒ«

**ã‚¨ãƒ©ãƒ¼å†…å®¹**:
```
pydantic_core._pydantic_core.ValidationError: 1 validation error for SQLExecutionLog
log_id
  Input should be a valid string [type=string_type, input_value=3, input_type=int]
```

**å•é¡Œ**: 
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã¯log_idãŒintã§è¿”ã•ã‚Œã‚‹
- Pydanticãƒ¢ãƒ‡ãƒ«ã§ã¯strã‚’æœŸå¾…ã—ã¦ã„ã‚‹
- å‹å¤‰æ›ãŒé©åˆ‡ã«è¡Œã‚ã‚Œã¦ã„ãªã„

**å½±éŸ¿**: ãƒ­ã‚°æ©Ÿèƒ½å…¨èˆ¬ãŒå‹•ä½œã—ãªã„

### å•é¡Œ2: æœªå®Ÿè£…ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
**ç™ºè¦‹ç®‡æ‰€**: `/logs/analytics`, `/logs/export`

**å•é¡Œ**: 
- ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¯å®šç¾©ã•ã‚Œã¦ã„ã‚‹ãŒã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„
- 404ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
- ãƒ†ã‚¹ãƒˆã§ã‚¹ã‚­ãƒƒãƒ—ãƒãƒ¼ã‚¯ãŒå¿…è¦

## ä¿®æ­£å„ªå…ˆåº¦ã¨æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### ğŸ”¥ é«˜å„ªå…ˆåº¦ (æœ¬ç•ªå½±éŸ¿å¤§)
1. **ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿APIä¾‹å¤–ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¿½åŠ 
2. **ãƒ­ã‚°APIã®Pydanticãƒ¢ãƒ‡ãƒ«ä¿®æ­£**: å‹å®šç¾©çµ±ä¸€
3. **ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆAPIã®Content-Typeä¿®æ­£**: HTTPãƒ˜ãƒƒãƒ€ãƒ¼é‡è¤‡è§£æ¶ˆ

### ğŸ“‹ ä¸­å„ªå…ˆåº¦ (é–‹ç™ºåŠ¹ç‡å½±éŸ¿)
4. **èªè¨¼APIãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ çµ±ä¸€**: APIã¨ãƒ†ã‚¹ãƒˆã®æ•´åˆæ€§
5. **ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ä¾‹å¤–å‡¦ç†æ”¹å–„**: å®‰å®šæ€§å‘ä¸Š

### ğŸ“ ä½å„ªå…ˆåº¦ (æ©Ÿèƒ½æ‹¡å¼µ)
6. **æœªå®Ÿè£…ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: å®Ÿè£…ã¾ãŸã¯ãƒ«ãƒ¼ãƒˆå‰Šé™¤

## APIè¨­è¨ˆã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ææ¡ˆ
1. **çµ±ä¸€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚¯ãƒ©ã‚¹ã¨HTTPExceptionå¤‰æ›
2. **ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼æ¨™æº–åŒ–**: æˆåŠŸãƒ»å¤±æ•—ã®ä¸€è²«ã—ãŸJSONã‚¹ã‚­ãƒ¼ãƒ
3. **ãƒ­ã‚°è¨­è¨ˆçµ±ä¸€**: æ§‹é€ åŒ–ãƒ­ã‚°ã¨ã‚¨ãƒ©ãƒ¼ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°
4. **å‹å®‰å…¨æ€§**: Pydanticãƒ¢ãƒ‡ãƒ«ã¨DBå‹ã®æ•´åˆæ€§ç¢ºä¿
