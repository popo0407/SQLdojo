# 改善アイテム一覧 (Improvement Items)

目的: 今後の機能/品質改善候補を可視化し、優先度と概算工数の目安を共有するためのリスト。

更新ルール:

- 追加時は「日付 / 追加者」を追記
- 状態(Status): Planned | In-Progress | Done | Dropped
- 工数(Effort): 開発実装 + 簡易テストの純工数目安 (レビュー/調整は別途)
- 依存(Dependency): 着手前提条件があれば記載

## フォーマット雛形

```
### [カテゴリ] タイトル (ID: YYYYMMDD-XX)
- 概要:
- 詳細:
- 価値 / 期待効果:
- 優先度: High | Medium | Low
- 工数目安: Xh / Xd
- 依存: なし / 具体的記述
- リスク/懸念:
- 状態: Planned
- 追加日: YYYY-MM-DD
```

---

## 改善候補一覧

### [フロントエンド] CSV 生成の Web Worker 化 (ID: 20250814-01)

- 概要: 大容量（>5〜10 万行）CSV 生成時の UI ブロッキングを回避するため、CSV 組立処理を Web Worker へオフロード。
- 詳細: `useResultsExportStore` の同期ループを Worker に移し、`postMessage` で進捗通知・完了通知。BOM 付与/文字列 → Blob 生成。進捗/キャンセル対応は段階導入。
- 価値 / 期待効果: 体感パフォーマンス向上、ブラウザフリーズ防止、UX 改善。将来の行数上限緩和の基盤。
- 優先度: Medium (現状即問題なければ後回し可)
- 工数目安: 最小実装 2–3h / 標準(進捗+キャンセル) 5–7h / 拡張(数百万行最適化) 1.5–2.5d
- 依存: 特になし (Vite の Worker サポートを利用)
- リスク/懸念: メモリ消費 (巨大配列結合), 進捗精度 (総件数不明時) , ブラウザ互換テスト
- 状態: Planned
- 追加日: 2025-08-14

### [フロントエンド] CSV 生成のストリーミング/チャンク化 (ID: 20250814-02)

- 概要: さらに巨大データ向けにチャンク単位で配列 → バッファ生成し逐次結合しメモリピーク低減。
- 詳細: Worker 内で一定行数ごとに `Uint8Array` を蓄積 → 最終 Blob 化。将来的には ReadableStream 経由のストリーミングダウンロードも検討。
- 価値: メモリ使用量安定化 / 非同期応答改善。
- 優先度: Low (現行要件次第)
- 工数目安: 0.5–1 日
- 依存: 20250814-01 (Worker 化)
- リスク: ブラウザ差異・実装複雑度増。
- 状態: Planned
- 追加日: 2025-08-14

### [フロントエンド] CSV 出力進捗 UI + キャンセルボタン (ID: 20250814-03)

- 概要: 生成中に進捗%とキャンセルを表示。
- 詳細: Worker から処理済行数を `postMessage`、総件数が未確定なら行カウントのみ。キャンセル時 `worker.terminate()`、UI 状態リセット。
- 価値: UX 向上 / 長時間時の安心感。
- 優先度: Medium
- 工数目安: 2–3h (Worker 前提)
- 依存: 20250814-01
- リスク: 進捗計測の不正確さ。
- 状態: Planned
- 追加日: 2025-08-14

### [フロントエンド] Excel 互換のための BOM 付与設定化 (ID: 20250814-04)

- 概要: CSV 冒頭に UTF-8 BOM 付与をオプション化。
- 詳細: 設定フラグ `include_utf8_bom` (UI 設定またはデフォルト ON) を見て `\uFEFF` 追加。
- 価値: Windows Excel での文字化け防止。
- 優先度: Low
- 工数目安: 0.5h
- 依存: なし
- リスク: 一部ツールで BOM を嫌うケース。
- 状態: Planned
- 追加日: 2025-08-14

### [バックエンド] CSV エクスポート API のストリーミング対応 (ID: 20250814-05)

- 概要: 大量データを一括メモリ保持せず、サーバ側でストリーミング (FastAPI StreamingResponse) による段階送信。
- 詳細: クエリ結果カーソルをイテレーションし行ごと／チャンクごとに `yield`。フィルタ/ソート適用後ストリーム化。フロントは fetch + `ReadableStream` (必要なら) で受信。
- 価値: メモリ効率向上 / より大きなデータセット対応。
- 優先度: Medium (データ量要件次第)
- 工数目安: 1–1.5 日 (テスト含む)
- 依存: なし (しかし前段で大容量ニーズ確認推奨)
- リスク: 既存キャッシュ/フィルタロジックの再利用設計。
- 状態: Planned
- 追加日: 2025-08-14

### [共通] エクスポート最大件数設定の UI 提示と動的警告 (ID: 20250814-06)

- 概要: `max_records_for_csv_download` を UI に表示し、超過時に事前警告 / 分割案内。
- 詳細: 設定値読込後に上限近接(90%超)で警告バナー、超過時は自動トリミング or サーバ問い合わせ拒否。
- 価値: ユーザの期待管理 / サポート工数削減。
- 優先度: Medium
- 工数目安: 1–2h
- 依存: 設定取得既存実装
- リスク: 過剰警告による UX 低下。
- 状態: Planned
- 追加日: 2025-08-14

### [フロントエンド] エラー通知の統一トースト/ダイアログ化 (ID: 20250814-07)

- 概要: エクスポート中エラー発生時の UX 統一 (トースト + 詳細ログコピー機能)。
- 詳細: 共通 `useNotification` など抽象化し、StackTrace は開閉 UI。
- 価値: デバッグ容易化 / 一貫性。
- 優先度: Low
- 工数目安: 2–3h
- 依存: 通知コンポーネント有無再確認
- リスク: 過剰情報表示。
- 状態: Planned
- 追加日: 2025-08-14

### [パフォーマンス] 大規模配列 → CSV 生成マイクロベンチ (ID: 20250814-08)

- 概要: 文字列結合戦略 (Array.join vs 逐次 concat) や エスケープ方式のベンチ。
- 詳細: 代表ケース(1 万/5 万/10 万行) の計測スクリプトを `scripts/bench_csv.ts` に。
- 価値: 最適化判断根拠の明確化。
- 優先度: Low
- 工数目安: 2h
- 依存: Node 実行環境
- リスク: 過早最適化
- 状態: Planned
- 追加日: 2025-08-14

### [バックエンド] グラフ付き Excel 出力 (閾値判定付き通常モード) (ID: 20250816-01)

- 概要: データ行数が設定閾値 (`max_rows_for_excel_chart`) 以下の場合は openpyxl 通常モードで Workbook を生成し、将来のグラフ挿入やスタイル拡張を可能にする出力方式を実装。閾値超過時は既存 write_only モードでグラフ無し高速/低メモリ出力を継続。
- 詳細: 1) 行数カウント → 2) 閾値比較 → 3) `mode = normal | write_only` 分岐。`include_charts` (将来オプション) が true かつ行数 <= 閾値なら通常モード + グラフ生成フック (初期はダミー/未実装)。行数超過時はレスポンスヘッダまたはメタ情報シート/ログに「グラフ省略」を明示。設定値は既に `config_simplified.py` に存在 (`max_rows_for_excel_chart`)。
- 価値 / 期待効果: 大規模データではメモリ効率維持、小規模〜中規模では表現力 (グラフ/書式) 拡張余地を確保。将来のマネージメント向け可視化資料生成基盤。
- 優先度: Medium (基盤整備)
- 工数目安: 0.5d (分岐 + テスト) / +0.5〜1d (簡易グラフ 1 種導入時) / +1.5d (複数グラフ+集計)
- 依存: 既存 Excel エクスポート実装, `max_rows_for_excel_chart` 設定, openpyxl
- リスク/懸念: 通常モード大容量時のメモリ増大/OOM, グラフ仕様確定前の過剰設計, テストデータ量確保コスト
- 状態: Planned
- 追加日: 2025-08-16

---

## 今後の追加候補メモ

- マルチタブ/セッション間の生成キュー管理
- ユーザごとの最近使ったエクスポート設定保存
- 圧縮 (gzip) 付きダウンロードオプション

---

最終更新日: 2025-08-14
