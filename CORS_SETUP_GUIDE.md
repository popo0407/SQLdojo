# 📖 本番環境 導入・運用ガイド（CORS 設定含む）

このドキュメントは、「HTML エディタシステム」を**本番サーバー（Node.js/npm 利用不可）**で公開し、チームで共有するための完全な手順をまとめたものです。環境変数を使って、開発環境と IIS 本番環境の両方で動作する CORS 設定を実装しています。

---

## Part 1: 【開発 PC での作業】 公開用パッケージの作成 📦

### 1-1. フロントエンドのビルド

開発 PC で、React アプリケーションを本番公開用の静的なファイル群に変換（ビルド）します。
これにより、`build`フォルダが作成されます。この中には HTML、CSS、JavaScript ファイルが含まれており、Web サーバーに置くだけで動作します。

```powershell
# フロントエンドのプロジェクトフォルダに移動

# 依存関係が未インストールの場合は実行
npm install

# 本番用ビルドを実行
npm run build
```

### 1-2. 公開用パッケージの作成

次に、本番サーバーに必要な**「バックエンドのソースコード」**と**「フロントエンドの完成品(`build`フォルダ)」**だけを抜き出して、一つの ZIP ファイルにまとめます。
以下の PowerShell スクリプトを実行してください。

1. PowerShell を管理者として開きます。

2. 作業しやすい場所（プロジェクトルート）へ移動するか、フルパスでスクリプトを呼び出します。

3. 実行ポリシーを一時的に緩めてスクリプトを実行します（現在のセッションのみ）。

Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process -Force

4. `create-deploy-package.ps1` の実行例（プロジェクトの `DeployPath` を指定して ZIP を作成）:

```powershell
# プロジェクトルートにいる場合（相対パスで DeployPath を渡す例）
.\create-deploy-package.ps1 -DeployPath "C:\Users\user\Downloads\SQLdojo" -DestinationZip "C:\Users\user\Downloads\DATAZIP_summary.zip"

# または ZIP のみを生成（引数未指定時はカレントディレクトリを DeployPath に、出力は Download フォルダに保存）
.\create-deploy-package.ps1
```

注意 (レポ構成との差異について):

本リポジトリの実際の構成は以下です。

```
$DeployPath\ (FastAPI バックエンド: app/ などがここに存在)
$DeployPath\sql-dojo-react\ (React/Vite フロントエンドソース)
```

`create-deploy-package.ps1` はこの“実構成”を入力として受け取り、ZIP 内では **deploy-to-iis.ps1 が想定する標準化構成** に再編します。

ZIP 内レイアウト (生成後):

```
frontend\  ← sql-dojo-react 内の dist (なければ build、両方無ければソース全体)
backend\   ← ルート直下からフロント関係/不要物を除外コピー
その他 *.md / *.txt / *.ps1 メタファイル
```

フロント側は `dist` → `build` の優先順でビルド成果物を自動検出し、見つからない場合は `sql-dojo-react` ディレクトリ全体をそのまま格納します。
（従来記載していた `$DeployPath\frontend` / `$DeployPath\backend` は ZIP 化後の論理構造を指すものに読み替えてください。）

---

## Part 2: 【本番サーバーでの作業】 環境構築と IIS での公開 🖥️

ここからの作業は、すべて本番サーバーで行います。

### 2-1. IIS の機能と必須モジュールの有効化とプロキシ設定(最初のアプリのみ)

コントロールパネルの「Windows の機能の有効化または無効化」で、以下の項目にチェックが入っていることを確認してください。



- **インターネット インフォメーション サービス**

さらに、IIS で Python アプリケーションを安定稼働させるための**推奨モジュール**をインストールします。

1.  **[Rewrite](https://www.iis.net/downloads/microsoft/url-rewrite)** をインストールします。
2.  **[Application Request Routing (ARR)](https://www.iis.net/downloads/microsoft/application-request-routing)** をインストールします。

#### プロキシの設定 🔐

設定＞ネットワークとインターネット＞プロキシ＞プロキシサーバーを使う＞　サーバー IP を;区切りで追加

### 2-3. 自動デプロイスクリプトの実行

**スクリプトの実行**:
Powershell を管理者で開いて以下のコードを実行します。
処理内容は後述
``` 
cd C:\Users\user\downloads\SQLDOJO\
PowerShell.exe -ExecutionPolicy Bypass -File "deploy-to-iis.ps1"
``` 

> **Note** > `deploy-to-iis.ps1`は、バックエンドを**NSSM (Non-Sucking Service Manager)** というツールで Windows サービス化しようと試みます。
> NSSM が見つからない場合、手動での起動を促すメッセージが表示されます。
> 安定運用のために、[NSSM 公式サイト](https://nssm.cc/download)からダウンロードし、
> `nssm.exe`を環境変数 PATH の通ったフォルダに配置しておくことを強く推奨します。

---

## Part 3: 【本番サーバーでの作業】共有設定 🤝

他の PC からアクセスできるように、ネットワークとセキュリティの設定を行います。

### 3-1. サーバーの IP アドレスを確認

### 3-3. CORS 設定の更新（環境変数ベース）

1. `backend/.env.example` をコピーして `backend/.env` を作成
2. `.env` ファイルにサーバーの IP アドレスを設定:

# IIS 環境用設定（例: サーバー IP = 192.168.1.10）

```
CORS_ORIGINS=http://192.168.1.10,http://192.168.1.10:3000,http://localhost:3000,http://localhost:82
```

---

## ✅ 最終確認とアクセス

### **他の PC からのアクセス**

同じネットワーク内の他の PC のブラウザで、以下のアドレスを入力してアクセスします。

HTTPS（暗号化）でのアクセス（Part 5 実施後）:
`https://<サーバーのIPアドレス>`
**例**: `https://192.168.1.10`

### ⚠️ **重要：チームメンバーへの周知事項**

自己署名証明書を使っている場合、他の PC からアクセスすると、**必ずブラウザにセキュリティ警告が表示されます**。

チームメンバーには、以下の手順でアクセスするよう周知してください。

1.  警告画面が表示されたら、「**詳細設定**」や「**詳細情報**」といったリンクをクリックします。
2.  「**（安全ではない）にアクセスする**」や「**このまま続行**」といったリンクをクリックします。

この操作は、ブラウザごとに初回アクセス時に必要となります。この警告は「証明書が公的な機関に認められていない」というだけで、**通信自体は暗号化されています**。

---

## 🔧 トラブルシューティング

### CORS エラーが発生する場合:

1. ブラウザの開発者ツールでエラー内容を確認
2. サーバーログで実際に設定されたオリジンを確認:
   ```
   CORS Origins (from env): ['http://192.168.1.10']
   ```
3. フロントエンドの API ベース URL が正しいか確認
4. IIS 環境では `web.config` の CORS 設定も確認

### 環境変数が読み込まれない場合:

1. `.env` ファイルの場所を確認（`backend/.env`）
2. ファイルの改行コードを確認（LF 推奨）
3. 環境変数名の綴りを確認（`CORS_ORIGINS`）

### **システム全体のトラブルシューティング**

- **アクセスできない場合**: ファイアウォールの設定（ポート 80、443）を再度確認してください。
- **API エラーが出る場合**: FastAPI サービスが正常に起動しているか確認してください (`nssm status HTMLEditorAPI` や、`backend`フォルダで`.\.venv\Scripts\Activate.ps1`を実行後に`python main.py`を手動実行してエラーが出ないか確認）。
- **権限エラーが出る場合**: `backend`フォルダや`*.db`ファイルに、IIS の実行ユーザー（`IIS_IUSRS`）の書き込み権限が付与されているか確認してください。

---

## ＜参考＞バックエンドの起動 🔐

cd $DeployPath\backend

python -m uvicorn main:app --host 0.0.0.0 --port 8002

## deploy-to-iis.ps1`スクリプトが行う設定の詳細

手動で確認・変更する場合の参考にしてください。

---はい、承知いたしました。このPowerShellスクリプトの処理内容を簡潔な箇条書きで説明します。

このスクリプトは、Webアプリケーション（フロントエンド＋バックエンド）をWindowsの**IIS（Internet Information Services）**に自動でデプロイし、設定するためのものです。

---

* **前提条件のチェック**
    * スクリプトが**管理者権限**で実行されているか確認します。
    * IISの管理用モジュールがインストールされているか確認します。

* **デプロイファイルの確認**
    * フロントエンドのビルド済みフォルダ（`dist` または `build`）と、バックエンドのソースコードが所定の場所にあるかを確認します。

* **バックエンド環境のセットアップ**
    * プロジェクト内のPython仮想環境（`.venv`）を探し、`requirements.txt`を基にライブラリをインストールします。
    * 仮想環境がない場合は、システムにインストールされているPythonを使用します。

* **IISサイトの作成と設定**
    * フロントエンド用の**IISウェブサイト**と、専用の**アプリケーションプール**を作成します。
    * 作成したサイトとフォルダに、IISがアクセスできるよう適切なファイル権限を付与します。

* **HTTPSの有効化**
    * **自己署名SSL証明書**を自動で作成し、サイトに割り当ててHTTPS（ポート443）を有効にします。
    * HTTP（ポート80）へのアクセスを、自動的にHTTPSへ転送（リダイレクト）するルールを設定します。

* **リバースプロキシの設定**
    * フロントエンドへの`/api/v1/`で始まるリクエストを、裏で動作しているバックエンドのAPIサーバー（例: `http://127.0.0.1:8001`）へ転送する**リバースプロキシ**を設定します。

* **バックエンドのサービス化**
    * **NSSM（Non-Sucking Service Manager）**というツールを使い、Pythonで書かれたバックエンドAPIを**Windowsサービス**として登録します。
    * これにより、サーバーが起動するとバックエンドAPIも自動で起動し、常にバックグラウンドで実行されるようになります。

* **完了報告**
    * すべての設定が完了した後、アクセス用のURLなどを画面に表示します。