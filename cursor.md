# AI エージェント開発ガイドライン

> **目的**: どの AI エージェントでも読み取れる統一的な開発ルール・ワークフロー・コーディング規約を 1 つのリポジトリで管理し、人間開発者と AI が同じ基準で作業できるようにする。
>
> **対象**: Python FASTAPIバックエンド を前提とした Web アプリ開発。言語が異なる場合はリンターやテストコマンドを適宜読み替えること。

---

## 1. 最上位原則

| #     | ルール                                                                           |
| ----- | -----------------------------------------------------------------------------|
| **1** | **geminiとの協調開発** ― **gemini -p <相談>** を実行することでgeminiと開発方針を協議すること  |
| **2** | **思考と言語の切り分け** ― AI の内部思考は **英語**、外部への回答・ドキュメントは **日本語**          |
| **3** | **絵文字禁止** ― コード、ドキュメント、コミットメッセージすべてで使用しない。                                    |
| **4** | **不要な空白を作らない** ― 特に日本語と英語の間に余計な全角・半角スペースを入れない。                                |
| **5** | **指令を忘れない** ― Agent起動時にcursor.mdを読み込み、最上位原則を全てチャット上に表示する。                                |

## gemini コマンドの与えられたタスクの開発方針についての相談実行例
gemini -P "FastAPI で JWT 認証をどう設計すべきか？"

---

## 2. コメント & ドキュメント規則

| 区分                                               | 記述言語         | 例                                   |
| ------------------------------------------------ | ------------ | ----------------------------------- |
| API / ライブラリドキュメント (JSDoc, Docstring, OpenAPI 説明) | **English**  | `/** Encrypt data with AES-256 */`  |
| テストケース名・埋め込みコメント                                 | **English**  | `describe('GET /pets returns 200')` |
| 実装背景・判断理由                                        | **Japanese** | `// バルク登録は速度優先のため一時テーブルを使用`         |

> 3 行以上の長文は `docs/` または ADR に切り出すこと。

---

## 3. `.tmp/` ディレクトリによるタスク管理

```
.tmp/
 ├─ design.md   # 要件・仕様
 └─ task.md     # チェックリスト
```

1. **`.tmp/design.md`** に要件・設計を文章化する。
2. サブタスクを **`.tmp/task.md`** に GitHub チェックリスト形式で列挙する。
3. 進捗に合わせて `- [x]` を更新する (唯一の真実の情報源にする)。
4. 計画が固まったら `feature/<概要>` ブランチを作成して実装開始。
5. 1 コミットは 1 変更単位 (目安: 5 ファイル or 100 行以下)。

---

## 4. Git ワークフロー & PR テンプレート

**`main` へ直接コミットしない。** 

### ブランチ命名規則

```
feature/<短い説明>
fix/<バグ ID>
docs/<セクション>
```

### Pull Request ボディ例

```md
## Key Changes
- ユーザ登録 API を FastAPI に移行

## Testing
- pytest 132/132 パス
- pnpm vitest カバレッジ 82 → 89 %

## Related Tasks
- #42, #77

## Other Notes
- 旧 API は 2025-08-01 削除予定
```

---

## 5. プログラミング規約

### Python

* **型ヒント必須** ― CI で `mypy --strict` を実行。
* 独自例外は `Exception` を継承し、`__str__` で詳細メッセージを返す。
* グローバルの可変状態を避け、DI (依存性注入) を優先。

### TypeScript

* `any` と `unknown` は原則禁止。
* `class` は継承や `instanceof` が必要な場合のみ使用し、基本は関数・モジュールで構成。

### 共通

* マジックナンバー / 直書き文字列を禁止し、定数または環境変数に切り出す。
* コミット前に必ずフォーマッターを実行。

---

## 6. 外部ツール利用ポリシー

### 6.1 リアルタイムドキュメント取得

* ライブラリ API の最新版は **Context7 MCP** などで取得してから実装する。

### 6.2 ブラウザ自動化 (Playwright MCP) 禁則事項

1. Python / JS / Bash などによる **任意コード実行は禁止**。
2. 利用可能なのは公式 MCP コマンド (`browser_navigate`, `browser_screenshot` など) のみ。
3. エラーが発生したら **即座に報告し停止**。回避策を探さない。

---

## 7. CI ゲート

| ステージ      | コマンド                                          | 基準      |
| --------- | --------------------------------------------- | ------- |
| Format    | `ruff format` / `pnpm prettier --check`       | パス必須    |
| Lint      | `ruff check` / `pnpm eslint --max-warnings 0` | エラー 0   |
| TypeCheck | `mypy --strict` / `tsc --noEmit`              | エラー 0   |
| UnitTest  | `pytest -q` / `pnpm vitest run`               | 全テスト成功  |
| Coverage  | `pytest --cov` / `vitest --coverage`          | 80 % 以上 |

失敗したらプッシュ・マージをブロック。

---

## 8. 補足

* `.tmp/` は **Git 管理対象** (計画ドキュメントとして共有)。
* `.env*` 系の機密値は Git 追跡対象外。
