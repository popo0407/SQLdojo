# AIエージェント開発ガイドライン `cursor.md` (最終版)

> **目的**: ユーザー、Cursor、Geminiの役割と基本原則を定義し、統一的なワークフローと規約のもとで開発の質と速度を最大化する。
>
> **対象**: Python FASTAPIバックエンドを前提としたWebアプリ開発。

-----

## 1\. 三位一体の開発原則

ユーザーの**意思決定**、Cursorの**分析と実行**、Geminiの**検証と助言**を組み合わせ、開発の質と速度を最大化します。

  - **ユーザー**: プロジェクトの目的・要件・最終ゴールを定義し、最終的な意思決定を行う**意思決定者**。
  - **Cursor**: 高度な計画力・高品質な実装・リファクタリング・ファイル操作・タスク管理を担う**実行者**。
  - **Gemini**: 深いコード理解・Web検索による最新情報へのアクセス・多角的な視点からの助言・技術的検証を行う**助言者**。

-----

## 2\. 最上位原則

| \#     | ルール                                                                                                                   |
| ----- | ------------------------------------------------------------------------------------------------------------------------ |
| **1** | **最優先の対話義務** ― **ユーザーの要求を受けたら、実装に着手する前に必ず `gemini -p "<開発方針の壁打ち>"` を実行すること。** |
| **2** | **思考と言語の切り分け** ― AIの内部思考は**英語**、外部への回答・ドキュメントは**日本語**。                                   |
| **3** | **絵文字禁止** ― コード、ドキュメント、コミットメッセージすべてで使用しない。                                                 |
| **4** | **不要な空白を作らない** ― 特に日本語と英語の間に余計な全角・半角スペースを入れない。                                         |
| **5** | **指令を忘れない** ― Agent起動時に`cursor.md`を読み込み、最上位原則を全てチャット上に表示する。                               |

-----

## 3\. 実践ガイド (Gemini活用)

  - **多角的な意見抽出**: Geminiの意見を鵜呑みにせず、一つの意見として判断します。聞き方を変えて多角的な意見を抽出してください。
  - **Web検索の利用**: Web検索が必要な場合は、原則として`gemini -p "..."` を利用します。
  - **エラー時のリトライ**: Geminiがエラーを返した場合は、以下の工夫をして再度試みてください。
      - 関連するファイル名や実行コマンドを渡す。
      - 質問を複数回に分割して聞く。

-----

## 4\. Geminiの主な活用場面

| \# | 場面 | 活用例 |
|---|---|---|
| 1 | **実現不可能な依頼** | Cursorでは対処できない要求への対応 (`今日の天気を教えて？` 等) |
| 2 | **前提確認** | ユーザーやCursor自身の思い込み・勘違いがないかの確認 (`この前提は正しいか？`) |
| 3 | **技術調査** | 最新情報、エラー解決、ドキュメント検索 (`FastAPI 1.0の新機能を調査して`) |
| 4 | **設計検証** | アーキテクチャや実装方針の妥当性確認 (`この設計パターンは適切か？`) |
| 5 | **コードレビュー** | 品質、保守性、パフォーマンスの評価 (`このコードの改善点は？`) |
| 6 | **計画立案** | タスク実行計画のレビューと改善提案 (`この実装計画の問題点は？`) |
| 7 | **技術選定** | ライブラリや手法の比較検討 (`この用途ならAとBのどちらのライブラリが良いか？`) |

-----

## 5\. `.tmp/` ディレクトリによるタスク管理

```
.tmp/
 ├─ design.md  # 要件・仕様
 └─ task.md    # チェックリスト
```

1.  Geminiとの壁打ちを経て固まった方針を **`.tmp/design.md`** に文章化します。
2.  サブタスクを **`.tmp/task.md`** にGitHubチェックリスト形式で列挙します。
3.  進捗に合わせて `- [x]` を更新し、唯一の真実の情報源とします。
4.  計画が固まったら `feature/<概要>` ブランチを作成して実装を開始します。
5.  1コミットは1変更単位（目安: 5ファイル or 100行以下）とします。

-----

## 6\. Gitワークフロー & PRテンプレート

**`main`への直接コミットは禁止です。**

### ブランチ命名規則

`feature/<短い説明>`, `fix/<バグID>`, `docs/<セクション>`

### Pull Requestボディ例

```md
## Key Changes
- ユーザ登録APIをFastAPIに移行

## Testing
- pytest 132/132 パス
- pnpm vitest カバレッジ 82 → 89 %

## Related Tasks
- #42, #77

## Other Notes
- 旧APIは2025-08-01削除予定
```

-----

## 7\. コーディング規約

  - **型ヒント必須**: CIで`mypy --strict`を実行します。
  - **マジックナンバー禁止**: 直書きの数値や文字列は定数または環境変数に切り出します。
  - **フォーマッター実行**: コミット前に必ず`ruff format`を実行します。
  - **コメント言語**:
      - **English**: APIドキュメント (Docstring)、テストケース名、埋め込みコメント
      - **Japanese**: 実装背景や判断理由を説明するコメント

-----

## 8\. CIゲート

| ステージ | コマンド | 基準 |
|---|---|---|
| Format | `ruff format --check` | パス必須 |
| Lint | `ruff check` | エラー0 |
| TypeCheck | `mypy --strict` | エラー0 |
| UnitTest | `pytest -q` | 全テスト成功 |
| Coverage | `pytest --cov` | 80%以上 |