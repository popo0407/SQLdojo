# SQLdojo_20250712 リファクタリング経緯・記録

## 1. リファクタリングの目的

- **主目的**: `useResultsStore.ts` のストア責務を見直し、よりシンプルかつ保守性の高い構成へリファクタリングすること。
  - 具体的には、Facade 的に肥大化した `useResultsStore.ts` から、各コンポーネントが必要なストア（`useResultsDataStore.ts` など）を直接利用する形へ移行。
  - これにより、状態依存の複雑化・再レンダリングの無駄・保守性低下を防ぐ。
  - 変更後も `useResultsStore` は「複数ストアをまとめて使いたい場合のショートカット」として残すが、必須ではなくする。

## 2. 実施した主な作業

- **影響範囲の特定**: `useResultsStore` を利用している主要コンポーネント・フック（例: `ResultsViewer`）を洗い出し。
- **段階的リファクタリング**: 各コンポーネントが必要なストアのみを直接 import するように修正。
- **ストアのテスト容易化**: Zustand 公式推奨の `createXxxStore` パターンで各ストアを生成関数化し、テストごとに独立したインスタンスを生成できるように変更。
- **テストの整備・移行**:
  - 既存の Jest テストは Zustand v5/ESM との互換性問題で失敗。
  - Jest/ts-jest の ESM 対応を最大限試みるも根本解決せず。
  - **Vitest へ全面移行**を決断し、ストア・コンポーネントテストを順次移行。
  - `vitest.config.ts` で `jsdom` 環境を設定し、React コンポーネントのテストが動作することを確認。
- **テストの段階的保証**:
  - まず「EmptyState（データなし）」状態のテスト（B 案）を優先し、テスト環境の正しさを証明。
  - その後、ストアのモックを用いた「データあり」状態のテスト（A 案）へ進む方針。

## 3. 成功した点

- Zustand ストアのテスト容易化（`createXxxStore`パターン）
- Vitest ＋ jsdom 環境でのテスト実行成功
- テストの段階的保証（まず B 案で環境の正しさを担保）
- 既存機能を壊さず、段階的に安全なリファクタリングを進行

## 4. 失敗・苦戦した点

- Jest/ts-jest と Zustand v5（ESM）の根本的な互換性問題
  - `getState is not a function` エラーが解消できず、Jest の設定を複数回調整するも根本解決せず
- テスト環境の切り分けに時間を要した
- コンポーネントの初期状態（ストアのモックなし時の分岐）により、意図した要素が出現しない問題

## 5. 今後の方針

- まず「データなし」状態のテスト（EmptyState が表示されること）をパスさせ、テスト環境の正しさを担保する（B 案）
- その後、ストアのモックを用意し「データあり」状態のテスト（A 案）へ進む
- 主要なコンポーネント・フックのテストを Vitest で整備し、リファクタリングの安全網を構築
- 不要になったファイル・コードの調査・削除
- README や開発ドキュメントの更新
- CI（GitHub Actions 等）で Vitest 自動実行の整備

---

## 参考: これまでの主なエラー・対応履歴

- `document is not defined` → vitest.config.ts で jsdom 環境を設定し解消
- `getState is not a function` → Jest/ts-jest の ESM 対応限界、Vitest 移行で解消
- `alert is not defined` → テスト内で `globalThis.alert = () => {}` でモック
- テストで意図した要素が出現しない → ストアの初期状態/モック不足が原因、B 案で切り分け

---

## まとめ

- 本リファクタリングは「ストアの責務分離・単純化」と「テスト容易性・安全網の強化」が主眼。
- Jest→Vitest 移行は Zustand v5/ESM 時代の必然的な選択。
- テストは段階的に保証し、まず環境の正しさ → ストアのモック → 本格的な動作保証へと進める。
- 今後も@cursor.md の開発憲章を順守し、段階的・安全・ドキュメント重視で進行すること。
