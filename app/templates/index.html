{% extends "base.html" %}

{% block title %}SQLエディタ - Snowsight風SQL Webアプリ{% endblock %}

{% block extra_css %}
<style>
    /* カスタムスタイル */
    .sql-editor-container {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        height: 300px; /* 初期高さを設定 */
        display: flex; /* 追加 */
        flex-direction: column; /* 追加 */
    }
    
    /* 追加: CodeMirrorの親コンテナが残りの高さを埋めるようにする */
    .sql-editor-container > .position-relative {
        flex-grow: 1;
    }

    /* 追加: CodeMirrorの高さを100%にして親コンテナに追従させる */
    .sql-editor, .CodeMirror {
        height: 100% !important;
    }
    
    .sql-toolbar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 12px 16px;
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .sql-toolbar .btn {
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .sql-toolbar .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .sql-templates {
        position: relative;
    }
    
    .template-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        min-width: 400px;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        max-height: 300px;
        overflow-y: auto;
        display: none;
    }
    
    .template-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f8f9fa;
        transition: background-color 0.2s ease;
    }
    
    .template-item:hover {
        background-color: #f8f9fa;
    }
    
    .template-item:last-child {
        border-bottom: none;
    }
    
    .template-title {
        font-weight: 600;
        color: #495057;
        margin-bottom: 4px;
    }
    
    .template-description {
        font-size: 0.875rem;
        color: #6c757d;
    }
    
    /* 水平リサイザー */
    .horizontal-resizer {
        height: 5px;
        background-color: #e9ecef;
        cursor: row-resize;
        transition: background-color 0.2s ease;
        margin: 8px 0;
        border-radius: 3px;
    }
    
    .horizontal-resizer:hover {
        background-color: #007bff;
    }
    
    .result-card {
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .result-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 16px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .result-stats {
        display: flex;
        gap: 16px;
        align-items: center;
    }
    
    .stat-item {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.875rem;
    }
    
    .export-buttons {
        display: flex;
        gap: 8px;
    }
    
    .export-buttons .btn {
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .export-buttons .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .table-container {
        max-height: 600px;
        overflow-y: auto;
        border-radius: 0 0 8px 8px;
    }
    
    .table {
        margin-bottom: 0;
    }
    
    .table th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 10;
        font-weight: 600;
        color: #495057;
    }
    
    .keyboard-shortcuts {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }
    
    .shortcuts-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        font-size: 1.2rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }
    
    .shortcuts-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(0,0,0,0.3);
    }
    
    .shortcuts-modal .modal-content {
        border-radius: 12px;
        border: none;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }
    
    .shortcut-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .shortcut-item:last-child {
        border-bottom: none;
    }
    
    .key {
        background-color: #e9ecef;
        padding: 2px 8px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 0.875rem;
        color: #495057;
    }
    
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        border-radius: 8px;
    }
    
    .spinner-border-sm {
        width: 1.5rem;
        height: 1.5rem;
    }
    
    /* レスポンシブ対応 */
    @media (max-width: 768px) {
        .sql-toolbar {
            flex-direction: column;
            align-items: stretch;
        }
        
        .sql-toolbar .btn-group {
            justify-content: center;
        }
        
        .result-stats {
            flex-direction: column;
            gap: 8px;
            align-items: flex-start;
        }
        
        .export-buttons {
            flex-direction: column;
            gap: 4px;
        }
        
        .keyboard-shortcuts {
            bottom: 10px;
            right: 10px;
        }
        
        .shortcuts-btn {
            width: 45px;
            height: 45px;
            font-size: 1rem;
        }
    }
    
    /* ダークモード対応 */
    @media (prefers-color-scheme: dark) {
        .template-dropdown {
            background: #343a40;
            border-color: #495057;
        }
        
        .template-item {
            border-bottom-color: #495057;
        }
        
        .template-item:hover {
            background-color: #495057;
        }
        
        .template-title {
            color: #e9ecef;
        }
        
        .template-description {
            color: #adb5bd;
        }
        
        .table th {
            background-color: #495057;
            color: #e9ecef;
        }
        
        .key {
            background-color: #6c757d;
            color: #e9ecef;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- メインコンテンツ -->
    <div class="col-md-12">
        <!-- Message Container -->
        <div id="message-container" class="my-3"></div>
        
        <!-- SQL Editor Card -->
        <div class="card sql-editor-container" id="sql-editor-container">
            <div class="sql-toolbar">
                <div class="d-flex gap-2 flex-wrap">
                    <div class="btn-group" role="group">
                        <button type="button" id="formatBtn" class="btn btn-light btn-sm" title="SQLを整形 (Ctrl+Shift+F)">
                            <i class="fas fa-magic me-1"></i>整形
                        </button>
                        <button type="button" id="clearBtn" class="btn btn-light btn-sm" title="SQLをクリア (Ctrl+L)">
                            <i class="fas fa-eraser me-1"></i>クリア
                        </button>
                    </div>
                    
                    <div class="btn-group" role="group">
                        <button type="button" id="validateBtn" class="btn btn-light btn-sm" title="SQLをバリデーション (Ctrl+Shift+V)">
                            <i class="fas fa-check me-1"></i>バリデーション
                        </button>
                    </div>
                    
                    <div class="sql-templates">
                        <button type="button" class="btn btn-light btn-sm dropdown-toggle" onclick="toggleTemplates()">
                            <i class="fas fa-file-code me-1"></i>テンプレート
                        </button>
                        <div class="template-dropdown" id="template-dropdown">
                            <div class="template-item" onclick="loadTemplate('select', 'SELECT * FROM table_name LIMIT 100;')">
                                <div class="template-title">基本SELECT</div>
                                <div class="template-description">テーブルからデータを取得</div>
                            </div>
                            <div class="template-item" onclick="loadTemplate('count', 'SELECT COUNT(*) as total_count FROM table_name;')">
                                <div class="template-title">件数取得</div>
                                <div class="template-description">レコード数をカウント</div>
                            </div>
                            <div class="template-item" onclick="loadTemplate('join', 'SELECT a.*, b.column_name FROM table1 a JOIN table2 b ON a.id = b.id;')">
                                <div class="template-title">JOIN</div>
                                <div class="template-description">テーブル結合</div>
                            </div>
                            <div class="template-item" onclick="loadTemplate('group', 'SELECT column_name, COUNT(*) as count FROM table_name GROUP BY column_name;')">
                                <div class="template-title">GROUP BY</div>
                                <div class="template-description">グループ化集計</div>
                            </div>
                            <div class="template-item" onclick="loadTemplate('window', 'SELECT *, ROW_NUMBER() OVER (PARTITION BY column_name ORDER BY created_at DESC) as rn FROM table_name;')">
                                <div class="template-title">ウィンドウ関数</div>
                                <div class="template-description">ランキング・順位付け</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex gap-2 align-items-center">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="limit-check" checked>
                        <label class="form-check-label text-white" for="limit-check">
                            結果制限 (5000件)
                        </label>
                    </div>
                    <button type="button" id="executeBtn" class="btn btn-success" title="SQL実行 (Ctrl+Enter)">
                        <i class="fas fa-play me-1"></i>実行
                    </button>
                </div>
            </div>
            
            <div class="position-relative">
                <div class="sql-editor">
                    <div id="monaco-editor-container" style="height: 100%; min-height: 300px;"></div>
                </div>
                <div class="loading-overlay" id="sql-loading" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">処理中...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 水平リサイザー -->
        <div class="horizontal-resizer" id="horizontal-resizer"></div>
        
        <!-- Validation Result -->
        <div id="validation-result" class="mt-3" style="display: none;"></div>
        
        <!-- Execution Result -->
        <div id="results-container" class="mt-3" style="display: none;">
            <div class="card result-card">
                <div class="result-header">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-table me-2"></i>
                        <h5 class="mb-0">実行結果</h5>
                    </div>
                    <div class="result-stats">
                        <div class="stat-item">
                            <i class="fas fa-list-ol"></i>
                            <span id="result-info">0件</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-clock"></i>
                            <span id="execution-time">0.000秒</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-sort-amount-down me-1"></i>
                            <span id="sortInfo">並び替えなし</span>
                        </div>
                        <!-- エクスポートボタンを結果ヘッダーに移動 -->
                        <div class="export-buttons">
                            <button type="button" id="exportCsvBtn" class="btn btn-light btn-sm" title="CSVファイルとして出力">
                                <i class="fas fa-file-csv me-1"></i>CSV
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="table-container">
                    <div id="dataTable"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Keyboard Shortcuts Modal -->
<div class="modal fade shortcuts-modal" id="shortcutsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-keyboard me-2"></i>キーボードショートカット
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="shortcut-item">
                    <span>SQL実行</span>
                    <span><span class="key">Ctrl</span> + <span class="key">Enter</span></span>
                </div>
                <div class="shortcut-item">
                    <span>SQL整形</span>
                    <span><span class="key">Ctrl</span> + <span class="key">Shift</span> + <span class="key">F</span></span>
                </div>
                <div class="shortcut-item">
                    <span>SQLクリア</span>
                    <span><span class="key">Ctrl</span> + <span class="key">L</span></span>
                </div>
                <div class="shortcut-item">
                    <span>SQLバリデーション</span>
                    <span><span class="key">Ctrl</span> + <span class="key">Shift</span> + <span class="key">V</span></span>
                </div>
                <div class="shortcut-item">
                    <span>全画面切り替え</span>
                    <span><span class="key">F11</span></span>
                </div>
                <div class="shortcut-item">
                    <span>ショートカット表示</span>
                    <span><span class="key">F1</span></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
            </div>
        </div>
    </div>
</div>

<!-- Keyboard Shortcuts Button -->
<div class="keyboard-shortcuts">
    <button type="button" class="shortcuts-btn" onclick="showKeyboardShortcuts()" title="キーボードショートカット">
        <i class="fas fa-keyboard"></i>
    </button>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', path='js/app.js') }}"></script>
<script>
    // テンプレートドロップダウンの切り替え
    function toggleTemplates() {
        const dropdown = document.getElementById('template-dropdown');
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    }
    
    // テンプレート読み込み
    function loadTemplate(type, sql) {
        sqlEditor.setValue(sql);
        document.getElementById('template-dropdown').style.display = 'none';
        sqlEditor.focus();
    }
    
    // キーボードショートカット表示
    function showKeyboardShortcuts() {
        const modal = new bootstrap.Modal(document.getElementById('shortcutsModal'));
        modal.show();
    }
    
    // 全画面切り替え
    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
        } else {
            document.exitFullscreen();
        }
    }
</script>
{% endblock %} 