{% extends "base.html" %}

{% block title %}SQLエディタ - Snowsight風SQL Webアプリ{% endblock %}

{% block extra_css %}{% endblock %}

{% block content %}
    <div class="main-stack" style="width:100%;max-width:100vw;">
        <!-- SQL Editor Card -->
        <div class="card sql-editor-container" id="sql-editor-container">
            <div class="sql-toolbar">
                <div class="d-flex gap-2 flex-wrap">
                    <div class="btn-group" role="group">
                        <button type="button" id="formatBtn" class="btn btn-light btn-sm" title="SQLを整形 (Ctrl+Shift+F)">
                            <i class="fas fa-magic me-1"></i>整形
                        </button>
                        <button type="button" id="clearBtn" class="btn btn-light btn-sm" title="SQLをクリア (Ctrl+L)">
                            <i class="fas fa-eraser me-1"></i>SQLクリア
                        </button>
                    </div>
                    
                    <div class="sql-templates">
                        <button type="button" class="btn btn-light btn-sm dropdown-toggle" onclick="toggleTemplates()">
                            <i class="fas fa-file-code me-1"></i>テンプレート
                        </button>
                        <div class="template-dropdown" id="template-dropdown">
                            <!-- ここはJSで動的に描画される -->
                        </div>
                    </div>
                    <button type="button" id="save-template-btn" class="btn btn-light btn-sm" title="テンプレート保存">
                        <i class="fas fa-eraser me-1"></i>テンプレート保存
                    </button>
                </div>
                
                <div class="d-flex gap-2 align-items-center">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="limit-check" checked>
                        <label class="form-check-label text-white" for="limit-check">
                            結果制限 (5000件)
                        </label>
                    </div>
                    <button type="button" id="toggleEditorBtn" class="btn btn-light btn-sm" title="エディタの最大化・最小化">
                        <i class="fas fa-expand me-1"></i>最大化
                    </button>
                    <button type="button" id="executeBtn" class="btn btn-success" title="SQL実行 (Ctrl+Enter)">
                        <i class="fas fa-play me-1"></i>実行
                    </button>
                </div>
            </div>
            
            <div class="position-relative">
                <div class="sql-editor">
                    <div id="monaco-editor-container" style="height: 100%; min-height: 300px; position: relative;"></div>
                </div>
                <div class="loading-overlay" id="sql-loading" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">処理中...</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- 水平リサイザー -->
        <div class="horizontal-resizer" id="horizontal-resizer"></div>
        <!-- Validation Result -->
        <div id="validation-result" class="mt-3" style="display: none;"></div>
        <!-- Execution Result -->
        <div id="results-container" class="mt-3" style="display: none;">
            <div class="card result-card">
                <div class="result-header">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-table me-2"></i>
                        <h5 class="mb-0">実行結果</h5>
                    </div>
                    <div class="result-stats">
                        <div class="stat-item">
                            <i class="fas fa-list-ol"></i>
                            <span id="result-info">0件</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-clock"></i>
                            <span id="execution-time">0.000秒</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-sort-amount-down me-1"></i>
                            <span id="sortInfo">並び替えなし</span>
                        </div>
                        <!-- エクスポートボタンを結果ヘッダーに移動 -->
                        <div class="export-buttons">
                            <button type="button" id="exportCsvBtn" class="btn btn-light btn-sm" title="CSVファイルとして出力">
                                <i class="fas fa-file-csv me-1"></i>CSV
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="table-container">
                    <div id="dataTable"></div>
                </div>
            </div>
        </div>
    </div>

<!-- Keyboard Shortcuts Modal -->
<div class="modal fade shortcuts-modal" id="shortcutsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-keyboard me-2"></i>キーボードショートカット
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="shortcut-item">
                    <span>SQL実行</span>
                    <span><span class="key">Ctrl</span> + <span class="key">Enter</span></span>
                </div>
                <div class="shortcut-item">
                    <span>SQL整形</span>
                    <span><span class="key">Ctrl</span> + <span class="key">Shift</span> + <span class="key">F</span></span>
                </div>
                <div class="shortcut-item">
                    <span>SQLクリア</span>
                    <span><span class="key">Ctrl</span> + <span class="key">L</span></span>
                </div>
                <div class="shortcut-item">
                    <span>全画面切り替え</span>
                    <span><span class="key">F11</span></span>
                </div>
                <div class="shortcut-item">
                    <span>ショートカット表示</span>
                    <span><span class="key">F1</span></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
            </div>
        </div>
    </div>
</div>

<!-- Keyboard Shortcuts Button -->
<div class="keyboard-shortcuts">
    <button type="button" class="shortcuts-btn" onclick="showKeyboardShortcuts()" title="キーボードショートカット">
        <i class="fas fa-keyboard"></i>
    </button>
</div>
{% endblock %}

{% block extra_js %}
    {% if public_server_url %}
        <script src="{{ public_server_url }}/static/js/app.js"></script>
    {% else %}
        <script src="{{ url_for('static', path='js/app.js') }}"></script>
    {% endif %}
    <script>
    document.getElementById('save-template-btn').addEventListener('click', function() {
        const sql = window.getCurrentEditorSQL ? window.getCurrentEditorSQL() : '';
        const name = prompt('テンプレート名を入力してください');
        if (!name || !sql) return;
        fetch('/api/v1/users/templates', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name, sql: sql })
        }).then(res => res.json()).then(data => {
            alert('テンプレートを保存しました');
        }).catch(() => alert('テンプレート保存に失敗しました'));
    });
    </script>
{% endblock %}