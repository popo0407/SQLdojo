# SQL Dojo

SQL Dojo は、Snowflake・Oracle・SQLite など複数のデータベースと連携した SQL クエリの実行・結果表示・エクスポートを行う Web アプリケーションです。

## 🚀 特徴

- **SQL クエリエディタ**: Monaco Editor による高機能な SQL エディタ（パラメータ保護フォーマット機能付き）
- **マルチデータベース対応**: Snowflake・Oracle・SQLite への接続と実行
- **マスターデータ管理**: 製造ライン設備マスター・測定値マスターの検索・更新・SQL 生成機能
- **リアルタイム実行**: SQL クエリのリアルタイム実行と結果表示
- **高度なフィルタリング**: 実行結果の詳細フィルタリング機能
- **データエクスポート**: 実行結果の Excel・CSV 形式でのエクスポート（グラフ埋め込み対応）
- **テンプレート機能**: SQL テンプレートの作成・管理・パーツ化
- **キャッシュ機能**: クエリ結果のキャッシュによる高速化
- **スケジューラー**: マスターデータの自動更新スケジューリング
- **管理機能**: クエリログの管理とメタデータ表示
- **レスポンシブ UI**: モダンな UI による快適な操作体験

## 🛠 技術スタック

### フロントエンド

- **React 19.1.0** + TypeScript
- **Vite** - ビルドツール
- **Zustand** - 状態管理
- **React Bootstrap** - UI コンポーネント
- **Monaco Editor** - SQL エディタ
- **React Query** - データフェッチング
- **React Router DOM** - ルーティング
- **Chart.js** - グラフ表示

### バックエンド

- **FastAPI 0.103.2** + Python
- **Uvicorn** - ASGI サーバー
- **pyodbc** - データベース接続（ODBC 経由）
- **Snowflake Connector** - Snowflake 専用接続
- **Oracle 接続** - Oracle Database 対応
- **SQLite** - 軽量データベース対応
- **Pandas** - データ処理
- **OpenPyXL / XlsxWriter** - Excel エクスポート
- **APScheduler** - タスクスケジューリング

### テスト

- **Vitest** - フロントエンドテスト
- **Jest** - 追加テストフレームワーク
- **React Testing Library** - コンポーネントテスト
- **pytest** - バックエンドテスト

## 📁 プロジェクト構造

```
SQLdojo/
├── app/                    # バックエンド (FastAPI)
│   ├── api/               # APIルーター・モデル・エラーハンドリング
│   │   └── routers/      # API エンドポイント（admin, cache, logs, master, metadata, etc.）
│   ├── services/          # ビジネスロジック
│   │   ├── admin_service.py
│   │   ├── cache_service.py
│   │   ├── master_data_service.py
│   │   ├── scheduler_service.py
│   │   └── connection_manager_*.py  # 各DB接続管理
│   ├── tests/            # バックエンドテスト
│   ├── utils/            # ユーティリティ
│   ├── main.py           # FastAPIアプリケーションエントリーポイント
│   └── config_simplified.py # 設定管理
├── sql-dojo-react/       # フロントエンド (React)
│   └── src/
│       ├── api/          # API通信
│       ├── components/   # 再利用可能UIコンポーネント
│       │   ├── editor/   # SQL エディタ関連
│       │   ├── layout/   # レイアウト関連
│       │   ├── master/   # マスターデータ関連
│       │   └── results/  # 結果表示関連
│       ├── features/     # 機能別コンポーネント
│       │   ├── results/  # 結果・フィルタリング機能
│       │   └── templates/ # テンプレート機能
│       ├── stores/       # Zustand状態管理
│       ├── types/        # TypeScript型定義
│       ├── utils/        # ユーティリティ
│       └── pages/        # ページコンポーネント
├── logs/                 # ログファイル
├── scripts/              # ユーティリティスクリプト
├── requirements.txt      # Python依存関係
├── *.db                  # SQLiteデータベースファイル
│   ├── session_manager.db       # セッション管理DB（セッションメタデータ）
│   ├── cache_{user_id}_{session_id}.db  # セッション別データDB（複数）
│   ├── metadata_cache.db        # メタデータキャッシュDB
│   ├── scheduler_jobs.db        # スケジューラジョブDB
│   └── job_execution_history.db # ジョブ実行履歴DB
└── README.md            # このファイル
```

## � 詳細仕様

### プロジェクト概要の詳細

SQL Dojo は、企業のデータ分析業務を効率化するために開発された Web ベースの SQL クエリ実行プラットフォームです。特に Snowflake データウェアハウスとの統合に特化しており、データアナリストや開発者が直感的に SQL クエリを作成・実行・共有できる環境を提供します。

#### 主な用途

- **データ分析**: 大容量データセットに対するアドホッククエリ実行
- **レポート作成**: 定期的なデータレポートの生成と自動化
- **データ探索**: 新しいデータセットの構造理解と探索
- **チーム協力**: SQL クエリの共有とバージョン管理

### 特徴の詳細説明

#### SQL クエリエディタ

- **構文ハイライト**: SQL 構文の色分け表示により、読みやすさを向上
- **オートコンプリート**: テーブル名、カラム名、SQL 関数の自動補完
- **エラー検出**: リアルタイムでの構文エラー検出と表示
- **フォーマット機能**: SQL クエリの自動整形とインデント調整
- **パラメータ保護フォーマット**: `{パラメータ}` 形式のパラメータを 1 つの塊として保護するフォーマット機能
- **複数タブ対応**: 複数のクエリを同時に編集可能

#### マスターデータ管理機能

- **設備マスター管理**: 製造ライン設備（STATION）情報の検索・表示・管理機能
- **測定値マスター管理**: 測定値・設定値（MEASURE）などの管理と STA_NO2 対応
- **検索機能**: 設備名・ライン名・各種番号による柔軟な検索
- **SQL 生成**: マスターデータから SQL 文の自動生成
- **クリップボード連携**: 生成された SQL をワンクリックでコピー
- **ユーザー設定保存**: 選択したマスター情報のユーザー毎保存
- **STEP 対応**: STEP3 以降での STA_NO2（1 桁目）の表示制御
- **自動更新**: スケジューラーによる定期的なマスターデータ更新

#### リアルタイム実行機能

- **非同期実行**: UI をブロックせずにクエリを実行
- **進捗表示**: 長時間実行クエリの進捗状況リアルタイム表示
- **キャンセル機能**: 実行中クエリの中断機能
- **実行履歴**: 過去に実行したクエリの履歴管理
- **パフォーマンス分析**: クエリ実行時間とリソース使用量の表示

#### データエクスポート機能

- **複数形式対応**: Excel (.xlsx)、CSV、JSON 形式でのエクスポート
- **大容量データ対応**: ストリーミング方式による大容量データの効率的エクスポート
- **フィルタリング**: エクスポート時のデータフィルタリング機能
- **圧縮オプション**: 大容量ファイルの ZIP 圧縮
- **チャート埋め込み**: Excel エクスポート時のグラフ自動生成
- **キャッシュからのエクスポート**: キャッシュされたデータの直接エクスポート

#### 高度なフィルタリング機能

- **データタイプ別フィルタ**: 文字列・数値・日付・真偽値別の最適化されたフィルタ UI
- **複数条件組み合わせ**: AND/OR 条件での複合フィルタリング
- **範囲指定**: 数値・日付の範囲指定フィルタ
- **部分一致検索**: 文字列の部分一致・前方一致・後方一致
- **NULL 値制御**: NULL 値の表示・非表示制御
- **リアルタイム適用**: フィルタ条件の即座反映

#### テンプレート機能

- **SQL テンプレート**: よく使用する SQL クエリのテンプレート化
- **パーツ管理**: テンプレートの部品化と再利用
- **テンプレート検索**: 名前・説明での検索機能
- **ドロップダウン選択**: エディタからの簡単なテンプレート挿入

#### キャッシュ機能

- **結果キャッシュ**: 同一クエリの結果をキャッシュして高速化
- **メタデータキャッシュ**: テーブル構造情報のキャッシュ
- **TTL 管理**: キャッシュの有効期限管理
- **キャッシュクリア**: 手動および自動キャッシュクリア機能
- **キャッシュ統計**: キャッシュヒット率・使用状況の監視
- **バッチ処理最適化**: SQLite ジャーナルファイルによる効率的なデータ保存（大容量データ処理時は間欠的な COMMIT 実行で性能向上）
- **セッション別DB分離**: セッションメタデータ（session_manager.db）とデータ（セッション別DB）を分離し、同時アクセスによる競合を回避
- **性能向上**: セッションごとに独立したDBファイル（cache_{user_id}_{session_id}.db）を使用することで、ロック競合を最小化

#### スケジューラー機能

- **自動更新**: マスターデータの定期的な自動更新
- **APScheduler**: Python ベースの高機能スケジューラー
- **ジョブ管理**: スケジュールされたジョブの管理・監視
- **実行履歴**: ジョブの実行履歴とログ記録
- **エラーハンドリング**: ジョブ実行エラーの適切な処理

#### 管理機能

- **ユーザー管理**: ロールベースアクセス制御 (RBAC)
- **クエリログ**: 全実行クエリの詳細ログ記録
- **リソース監視**: システムリソースの使用状況監視
- **設定管理**: データベース接続設定の一元管理
- **メタデータ管理**: データベーススキーマ情報の管理
- **ログ削除機能**: 古いログの自動削除とメンテナンス

#### レスポンシブ UI

- **モバイル対応**: タブレット・スマートフォンでの利用可能
- **ダークモード**: 目に優しいダークテーマ対応
- **カスタマイズ**: ユーザー個別の UI 設定保存
- **アクセシビリティ**: WCAG 準拠のアクセシビリティ対応

### SQL 実行処理フローとフロントエンド表示

#### SQL 実行処理の流れ

1. **クエリ解析・検証**

   - SQL 構文の事前チェック
   - パラメータの妥当性検証
   - 実行権限の確認

2. **キャッシュ確認**

   - 同一クエリのキャッシュ存在確認
   - キャッシュヒット時は即座に結果返却
   - キャッシュミス時は実際の DB 実行へ

3. **データベース実行**

   - 非同期での SQL 実行開始
   - 進捗状況のリアルタイム追跡
   - タイムアウト・キャンセル機能

4. **データ処理・変換**

   - Pandas を使用したデータ処理
   - 型変換・フォーマット調整
   - 大容量データのチャンク処理

5. **結果キャッシュ・保存**
   - 実行結果のキャッシュ保存
   - セッション管理とクリーンアップ
   - 実行ログの記録

#### フロントエンド表示機能

**リアルタイム実行状況表示**

- 実行進捗のプログレスバー表示（**注意**: バッチ処理最適化により、プログレスバーの更新タイミングとディスクへの実際のデータ保存タイミングが異なります）
- 処理済み行数・残り時間の推定表示（メモリ内処理進捗ベース）
- キャンセルボタンによる実行中断機能
- **技術的制約**: 大容量データ処理時は、性能最適化のためバッチ処理が採用されており、SQLite ジャーナルファイル（cache-data.db-journal）の生成・削除は間欠的（約 10 回程度、30 秒間隔）に発生します。プログレスバーはメモリ内での処理進捗を即座に反映しますが、実際のディスク書き込み（.db-journal ファイル更新）はバッチ単位で実行されるため、プログレスバー表示とディスク活動のタイミングにずれが生じます

**結果データ表示**

- 仮想化テーブルによる大容量データの高速表示
- カラムの動的リサイズ・ソート機能
- ページネーション（デフォルト 200 行/ページ）
- データタイプ別の適切な表示形式（数値、日付、テキスト）

**インタラクティブフィルタリング**

- カラムヘッダーからの即座フィルタ設定
- データタイプ別の最適化されたフィルタ UI
  - 文字列: 部分一致・完全一致・正規表現
  - 数値: 範囲指定・比較演算子
  - 日付: カレンダー選択・期間指定
  - 真偽値: チェックボックス選択
- 複数フィルタの組み合わせ（AND/OR 条件）

**統計情報表示**

- 総行数・フィルタ後行数の表示
- 実行時間・データサイズの表示
- キャッシュヒット・ミス状況の表示

**エクスポート機能**

- ワンクリックでの各種形式エクスポート
- 進捗表示付きの大容量データエクスポート
- フィルタ適用状態での部分エクスポート

**エラーハンドリング表示**

- SQL 構文エラーの詳細表示
- データベース接続エラーの分かりやすい表示
- タイムアウト・キャンセル時の適切なメッセージ表示

### 技術スタックの詳細説明

#### フロントエンド技術詳細

**React 19.1.0 + TypeScript**

- 最新の React 機能（Concurrent Features、Suspense）を活用
- TypeScript 厳密モードによる型安全性の確保
- 関数コンポーネント + Hooks パターンの採用

**Vite（ビルドツール）**

- 高速なホットリロード機能
- ES Modules ベースの最適化されたビルド
- プラグインエコシステムによる拡張性

**Zustand（状態管理）**

- 軽量で直感的な API
- TypeScript 完全対応
- Redux DevTools との統合

**React Bootstrap（UI コンポーネント）**

- Bootstrap 5 ベースのコンポーネント
- レスポンシブデザインの標準化
- カスタムテーマ対応

**Monaco Editor（SQL エディタ）**

- VS Code と同じエディタエンジン
- SQL 構文ハイライトとオートコンプリート
- カスタムキーバインド対応
- **カスタムフォーマッタ**: パラメータ `{パラメータ}` を保護するフォーマット機能（パラメータが改行で分割されないよう保護）

**React Query（データフェッチング）**

- サーバー状態の効率的な管理
- 自動キャッシュとバックグラウンド更新
- エラーハンドリングとリトライ機能

**Chart.js（グラフ表示）**

- 多様なチャートタイプ対応
- インタラクティブなデータ可視化
- レスポンシブグラフ対応

#### バックエンド技術詳細

**FastAPI 0.103.2 + Python**

- 高性能な ASGI フレームワーク
- 自動 OpenAPI/Swagger 文書生成
- Python 型ヒントによるバリデーション

**Uvicorn（ASGI サーバー）**

- 高速な async/await 対応
- ホットリロード機能
- 本番環境での Gunicorn 統合

**pyodbc（データベース接続）**

- 汎用 ODBC 接続ライブラリ
- 複数データベース対応（Snowflake、Oracle、SQLite）
- 接続プール管理
- DSN-less 接続対応

**Snowflake Connector**

- Snowflake 最適化された専用コネクタ
- キーペア認証・パスワード認証対応
- SSO 認証対応
- 大容量データの効率的転送
- プロキシ経由接続対応

**Oracle 接続**

- Oracle Database 対応
- ODBC DSN 設定または DSN-less 接続
- サービス名・SID 両方対応
- Oracle Client ライブラリ対応

**SQLite**

- 軽量データベースエンジン
- ローカルファイルベース
- 開発・テスト環境での利用

**Pandas（データ処理）**

- 高性能なデータ操作ライブラリ
- メモリ効率的なデータ処理
- 豊富なデータ変換機能

**OpenPyXL / XlsxWriter（Excel エクスポート）**

- Excel ファイルの読み書き
- 複雑なフォーマッティング対応
- チャートとマクロの埋め込み

**APScheduler（タスクスケジューリング）**

- Python ベースのジョブスケジューラー
- データベース永続化ジョブストア
- バックグラウンド実行
- 豊富なトリガー（cron、interval、date）

#### テスト技術詳細

**Vitest（フロントエンドテスト）**

- Vite ネイティブなテストランナー
- Jest 互換 API
- 高速なテスト実行

**React Testing Library**

- ユーザー中心のテストアプローチ
- アクセシビリティテスト対応
- 実際の DOM 操作テスト

**pytest（バックエンドテスト）**

- 豊富なプラグインエコシステム
- 並列テスト実行
- カバレッジレポート生成

### プロジェクト構造の詳細説明

#### バックエンド構造（app/）

**api/ディレクトリ**

- `routes.py`: メイン API エンドポイントの定義
- `models.py`: Pydantic モデルとスキーマ定義
- `error_handlers.py`: エラーハンドリングとレスポンス統一
- `error_utils.py`: エラー処理ユーティリティ関数
- `routers/`: 機能別 API ルーター
  - `admin.py`: 管理者機能 API
  - `cache.py`: キャッシュ管理 API
  - `logs.py`: ログ管理 API
  - `master.py`: マスターデータ API
  - `metadata.py`: メタデータ管理 API
  - `settings.py`: 設定管理 API

**services/ディレクトリ**

- `admin_service.py`: 管理機能のビジネスロジック
- `cache_service.py`: キャッシュ管理サービス
- `completion_service.py`: SQL オートコンプリート機能
- `master_data_service.py`: マスターデータ管理サービス
- `master_search_preference_service.py`: マスター検索設定サービス
- `scheduler_service.py`: スケジューラー管理サービス
- `metadata_service.py`: メタデータ管理サービス
- `connection_manager_*.py`: 各データベース接続管理
  - `connection_manager_snowflake_log.py`: Snowflake 接続
  - `connection_manager_oracle.py`: Oracle 接続
  - `connection_manager_sqlite.py`: SQLite 接続
  - `connection_manager_odbc.py`: 汎用 ODBC 接続

**tests/ディレクトリ**

- 各機能ごとのユニットテスト
- 統合テスト
- テストフィクスチャとモック

**utils/ディレクトリ**

- 共通ユーティリティ関数
- データ変換処理
- 設定管理ヘルパー

#### フロントエンド構造（sql-dojo-react/src/）

**api/ディレクトリ**

- API クライアント関数
- リクエスト/レスポンス型定義
- エラーハンドリング

**components/ディレクトリ**

- 再利用可能な UI コンポーネント
- 基本的な UI 要素（ボタン、入力フィールドなど）
- レイアウトコンポーネント
- `editor/`: SQL エディタ関連コンポーネント
- `layout/`: レイアウト・ヘッダー・サイドバー
- `master/`: マスターデータ表示・検索コンポーネント
- `results/`: 結果表示・統計・ヘッダー関連
- `tabs/`: タブ機能関連コンポーネント

**features/ディレクトリ**

- 機能別のコンポーネントグループ
- `results/`: データ表示・フィルタリング・チャート機能
- `templates/`: テンプレート管理機能
- SQL エディタ機能
- エクスポート機能

**stores/ディレクトリ**

- Zustand 状態管理ストア
- アプリケーション状態
- ユーザー設定
- `useMasterDataStore.ts`: マスターデータ状態管理
- `useResultsFilterStore.ts`: フィルタリング状態管理
- `useSidebarMasterDataStore.ts`: サイドバー状態管理
- `useTabStore.ts`: タブ状態管理

**types/ディレクトリ**

- TypeScript 型定義
- API 型定義
- 共通インターフェース
- `masterData.ts`: マスターデータ関連型
- `results.ts`: 結果・フィルター関連型

**pages/ディレクトリ**

- ルートレベルのページコンポーネント
- ページ固有のロジック

#### 追加ディレクトリ

**logs/ディレクトリ**

- アプリケーションログファイル
- エラーログ
- アクセスログ
- SQL クエリ実行ログ

**scripts/ディレクトリ**

- デプロイメントスクリプト
- データベースマイグレーション
- ユーティリティスクリプト

## �🚦 はじめに

### 必要な環境

- **Python 3.11+**
- **Node.js 18+**
- **npm**

### 環境セットアップ

#### 1. リポジトリのクローン

```bash
git clone <repository-url>
cd SQLdojo
```

#### 2. バックエンドセットアップ

```bash
# Python仮想環境作成・有効化
python -m venv .venv
.venv/Scripts/activate     # Windows
# または
source .venv/bin/activate  # Linux/Mac

# 依存関係インストール
pip install -r requirements.txt
```

#### 3. フロントエンドセットアップ

```bash
cd sql-dojo-react
npm install
```

#### 4. 環境変数設定

```bash
# プロジェクトルートに .env ファイルを作成
cp env.example .env
# 必要な環境変数を設定（Snowflake接続情報など）
```

## 🏃‍♂️ 開発サーバーの起動

### バックエンド起動

```bash
# プロジェクトルートで実行
uvicorn app.main:app --reload --port 8001
```

バックエンドは http://localhost:8001 で起動します

### フロントエンド起動

```bash
cd sql-dojo-react
npm run dev
```

フロントエンドは http://localhost:5173 で起動します

## 🧪 テスト実行

### バックエンドテスト

```bash
# プロジェクトルートで実行
pytest                     # 全テスト実行
pytest --cov              # カバレッジ付き実行
pytest app/tests/test_*.py # 特定テストファイル実行
```

### フロントエンドテスト

```bash
cd sql-dojo-react
npm test                   # Vitestテスト実行
npm run test:watch         # ウォッチモード
npm run test:coverage      # カバレッジ付き実行
npm run test:jest          # Jestテスト実行
```

## 📊 主な機能

### 1. SQL クエリエディタ

- Monaco Editor による構文ハイライト
- オートコンプリート機能
- クエリ履歴管理
- パラメータ保護フォーマット機能

### 2. マスターデータ管理

- 製造ライン設備マスター・測定値マスターの検索・管理
- 柔軟な検索条件とフィルタリング
- SQL 自動生成とクリップボード連携
- ユーザー毎の検索設定保存
- 自動更新スケジューリング

### 3. データ表示・エクスポート

- テーブル形式での結果表示
- 高度なフィルタリング機能（データタイプ別 UI）
- Excel・CSV 形式でのエクスポート
- 大容量データの効率的な表示
- チャート埋め込み対応 Excel エクスポート

### 4. テンプレート・パーツ機能

- よく使用する SQL のテンプレート化
- 再利用可能な SQL パーツ管理
- ドロップダウンからの簡単挿入
- テンプレート検索機能

### 5. 管理機能

- クエリ実行ログの管理
- データベースメタデータの表示
- システム設定管理
- スケジューラー管理
- ユーザー権限管理

### 6. パフォーマンス最適化

- クエリ結果のキャッシュ機能
- 仮想化による大量データ表示
- 非同期処理による応答性向上
- メタデータキャッシュによる高速化

## 🏗 開発ガイドライン

### コーディング規約

- **単一責任原則 (SRP)**: 1 つのコンポーネント/関数は 1 つの責務のみ
- **関心の分離 (SoC)**: UI、ロジック、データアクセスの分離
- **TypeScript**: 厳密な型定義の使用
- **テスト駆動開発**: 高リスク変更は必須テスト

### ファイル命名規則

- コンポーネント: PascalCase (例: `SqlEditor.tsx`)
- hooks: camelCase with "use" prefix (例: `useEditorStore.ts`)
- utils: camelCase (例: `dataParser.ts`)

詳細は `Rule_of_coding.md` を参照してください。

## 🔌 API 仕様

SQL Dojo は包括的な RESTful API を提供し、SQL クエリの実行、データ管理、システム管理の機能を提供します。

### 認証 API (`/auth`)

| エンドポイント  | メソッド | 説明                   | 認証   |
| --------------- | -------- | ---------------------- | ------ |
| `/login`        | POST     | ユーザーログイン       | 不要   |
| `/logout`       | POST     | ユーザーログアウト     | 必要   |
| `/refresh`      | POST     | トークンリフレッシュ   | 必要   |
| `/users/me`     | GET      | 現在のユーザー情報取得 | 必要   |
| `/admin/login`  | POST     | 管理者ログイン         | 不要   |
| `/admin/logout` | POST     | 管理者ログアウト       | 管理者 |

### SQL クエリ API (`/sql`)

| エンドポイント  | メソッド | 説明                         | 機能                           |
| --------------- | -------- | ---------------------------- | ------------------------------ |
| `/format`       | POST     | SQL クエリの整形             | 構文ハイライト、インデント調整 |
| `/suggest`      | POST     | SQL オートコンプリート       | テーブル名、カラム名の候補提供 |
| `/download/csv` | POST     | CSV ダウンロード（認証不要） | 直接 SQL 実行結果を CSV 出力   |

### キャッシュ API (`/sql/cache`)

| エンドポイント          | メソッド | 説明                     | 機能                                 |
| ----------------------- | -------- | ------------------------ | ------------------------------------ |
| `/execute`              | POST     | キャッシュ付き SQL 実行  | 高速化、進捗管理、大容量データ対応   |
| `/read`                 | POST     | キャッシュデータ読み込み | ページング、フィルタリング、ソート   |
| `/status/{session_id}`  | GET      | 実行状況確認             | 進捗率、処理済み行数の取得           |
| `/cancel`               | POST     | 実行中断                 | 長時間クエリのキャンセル             |
| `/session/{session_id}` | DELETE   | セッションクリーンアップ | キャッシュデータの削除               |
| `/user/{user_id}`       | DELETE   | ユーザーキャッシュクリア | 特定ユーザーのキャッシュ全削除       |
| `/clipboard/tsv`        | POST     | TSV クリップボード出力   | 表計算ソフト向けタブ区切り形式       |
| `/download/excel`       | POST     | Excel ダウンロード       | チャート埋め込み、高度なフォーマット |
| `/unique-values`        | POST     | カラム固有値取得         | フィルタリング用の選択肢提供         |
| `/dummy-data`           | POST     | ダミーデータ生成         | 開発・テスト用データ作成             |

### メタデータ API (`/metadata`)

| エンドポイント                             | メソッド | 説明                                 | 機能                                       |
| ------------------------------------------ | -------- | ------------------------------------ | ------------------------------------------ |
| `/all`                                     | GET      | 全メタデータ取得（権限フィルタ済み） | ユーザー権限に応じたスキーマ・テーブル情報 |
| `/initial`                                 | GET      | 初期メタデータ取得                   | アプリ起動時の基本情報                     |
| `/raw`                                     | GET      | 生メタデータ取得                     | フィルタリング前の全データ                 |
| `/refresh-cache`                           | POST     | メタデータキャッシュ更新             | 最新の DB 構造情報を取得                   |
| `/cache`                                   | DELETE   | メタデータキャッシュクリア           | キャッシュの強制削除                       |
| `/schemas`                                 | GET      | スキーマ一覧取得                     | データベーススキーマのリスト               |
| `/schemas/{schema}/tables`                 | GET      | テーブル一覧取得                     | 指定スキーマ内のテーブル                   |
| `/schemas/{schema}/tables/{table}/columns` | GET      | カラム一覧取得                       | 指定テーブルのカラム情報                   |
| `/visibility-settings`                     | GET/POST | 表示設定管理                         | スキーマ・テーブルの表示/非表示制御        |

### 管理者 API (`/admin`)

#### テンプレート・パーツ管理

| エンドポイント | メソッド        | 説明                 | 機能                      |
| -------------- | --------------- | -------------------- | ------------------------- |
| `/templates`   | GET/POST/DELETE | SQL テンプレート管理 | 定型クエリの作成・管理    |
| `/parts`       | GET/POST/DELETE | SQL パーツ管理       | 再利用可能な SQL 部品管理 |

#### システム管理

| エンドポイント         | メソッド   | 説明                 | 機能                         |
| ---------------------- | ---------- | -------------------- | ---------------------------- |
| `/system/refresh`      | POST       | システムリフレッシュ | 各種キャッシュの一括更新     |
| `/visibility-settings` | GET/POST   | 表示設定管理         | 全体的な表示制御設定         |
| `/logs/sql`            | GET/DELETE | SQL ログ管理         | 全ユーザーのクエリログ管理   |
| `/metadata/all-raw`    | GET        | 管理者用メタデータ   | フィルタなしの完全な DB 情報 |
| `/business-users`      | GET/POST   | ビジネスユーザー管理 | ユーザー権限・グループ管理   |

### ログ API (`/logs`)

| エンドポイント | メソッド   | 説明                    | 機能                                   |
| -------------- | ---------- | ----------------------- | -------------------------------------- |
| `/sql`         | GET/DELETE | ユーザー SQL ログ       | 個人のクエリ履歴管理                   |
| `/admin/sql`   | GET/DELETE | 全 SQL ログ（管理者用） | 全ユーザーのログ表示・削除             |
| `/analytics`   | GET        | ログ分析                | 使用統計・パフォーマンス分析（未実装） |
| `/export`      | POST       | ログエクスポート        | ログデータのエクスポート（未実装）     |

### ユーティリティ API (`/utils`)

| エンドポイント         | メソッド | 説明               | 機能                      |
| ---------------------- | -------- | ------------------ | ------------------------- |
| `/health`              | GET      | ヘルスチェック     | システム状態・DB 接続確認 |
| `/connection/status`   | GET      | DB 接続状況        | 接続プールの状態確認      |
| `/export`              | POST     | データエクスポート | 汎用 CSV エクスポート機能 |
| `/performance/metrics` | GET      | パフォーマンス指標 | システムリソース使用状況  |

### マスターデータ API (`/master`)

| エンドポイント        | メソッド | 説明                     | 機能                                  |
| --------------------- | -------- | ------------------------ | ------------------------------------- |
| `/update`             | POST     | マスターデータ一括更新   | 設備・測定値マスターの最新化          |
| `/stations`           | GET      | 設備マスター検索         | 複数条件での設備情報検索              |
| `/generate-sql`       | POST     | SQL 自動生成             | 選択されたマスターデータから SQL 生成 |
| `/search-preferences` | GET/POST | 検索設定管理             | ユーザー毎の検索設定保存・取得        |
| `/update-progress`    | GET      | 更新進捗確認             | マスターデータ更新の進捗状況          |
| `/schedule/update`    | POST     | 自動更新スケジュール設定 | 定期的な自動更新の設定                |
| `/schedule/status`    | GET      | スケジュール状況確認     | 設定されたスケジュールの確認          |

### 設定 API (`/config`)

| エンドポイント | メソッド | 説明                 | 機能                               |
| -------------- | -------- | -------------------- | ---------------------------------- |
| `/settings`    | GET      | アプリケーション設定 | ページサイズ、制限値などの設定取得 |

### ユーザー API (`/users`)

| エンドポイント        | メソッド | 説明               | 機能                               |
| --------------------- | -------- | ------------------ | ---------------------------------- |
| `/history`            | GET      | ユーザー履歴       | 個人の SQL 実行履歴（直近 6 か月） |
| `/templates/dropdown` | GET      | テンプレート選択肢 | ドロップダウン用のテンプレート一覧 |
| `/parts/dropdown`     | GET      | パーツ選択肢       | ドロップダウン用のパーツ一覧       |

## 🔧 環境変数設定

SQL Dojo は以下の環境変数で動作をカスタマイズできます。`.env`ファイルに設定してください。

### データベース接続設定

#### Snowflake 接続（メイン）

```bash
# Snowflake接続情報
SNOWFLAKE_ACCOUNT=your-account.snowflakecomputing.com
SNOWFLAKE_USER=your_username
SNOWFLAKE_PRIVATE_KEY_PATH=/path/to/rsa_key.p8
SNOWFLAKE_PRIVATE_KEY_PASSPHRASE=your_passphrase
SNOWFLAKE_WAREHOUSE=your_warehouse
SNOWFLAKE_DATABASE=your_database
SNOWFLAKE_SCHEMA=your_schema
SNOWFLAKE_ROLE=your_role
SNOWFLAKE_USE_KEYPAIR=true  # 鍵ペア認証の有効化
```

#### ログストレージ設定

```bash
# ログ保存先の選択
LOG_STORAGE_TYPE=sqlite  # sqlite | oracle

# SQLite設定（推奨）
SQLITE_LOG_DB_PATH=./logs/sql_logs.db

# Oracle設定（オプション）
ORACLE_DRIVER=Oracle in OraDB19Home1
ORACLE_HOST=your_oracle_host
ORACLE_PORT=1521
ORACLE_SID=your_sid
ORACLE_USER=your_oracle_user
ORACLE_PASSWORD=your_oracle_password
ORACLE_DSN=your_dsn
```

### アプリケーション設定

#### サーバー設定

```bash
# FastAPIサーバー設定
APP_HOST=0.0.0.0
APP_PORT=8001
APP_DEBUG=false
PUBLIC_SERVER_URL=http://your-server-url:8080

# セキュリティ設定
SECRET_KEY=your-secret-key-here
ADMIN_PASSWORD=your-admin-password
```

#### ログレベル設定

```bash
# ログレベル選択
LOG_LEVEL=INFO  # DEBUG | INFO | WARNING | ERROR | CRITICAL

# DEBUG: 最も詳細な情報（開発時のデバッグ用）
# INFO: 正常な動作を示す情報
# WARNING: 予期しない事象や将来問題になる可能性
# ERROR: 重大なエラー（処理が正常完了できない）
# CRITICAL: 致命的なエラー
```

### パフォーマンス・制限設定

#### データ処理制限

```bash
# ページング設定
DEFAULT_PAGE_SIZE=200           # デフォルトページサイズ
CURSOR_CHUNK_SIZE=2000          # データベースから一度に取得する行数

# 大容量データ処理制限
MAX_RECORDS_FOR_DISPLAY=10000000      # 画面表示可能な最大行数
MAX_RECORDS_FOR_CSV_DOWNLOAD=10000000 # CSV出力可能な最大行数
MAX_RECORDS_FOR_EXCEL_DOWNLOAD=1000000 # Excel出力可能な最大行数
MAX_RECORDS_FOR_CLIPBOARD_COPY=50000   # クリップボードコピー可能な最大行数
MAX_ROWS_FOR_EXCEL_CHART=100000        # Excelチャート作成可能な最大行数
```

#### キャッシュ管理設定

```bash
# キャッシュ自動クリーンアップ
CACHE_CLEANUP_ENABLED=true                 # 自動クリーンアップの有効化
CACHE_CLEANUP_INTERVAL_MINUTES=15          # クリーンアップ実行間隔（分）
CACHE_SESSION_TIMEOUT_MINUTES=30           # セッションタイムアウト時間（分）
CACHE_SESSION_CLEANUP_HOURS=12             # セッション削除までの時間（時間）
```

#### タイムアウト設定

```bash
# 各種タイムアウト設定
CONNECTION_TIMEOUT_SECONDS=30    # データベース接続タイムアウト
QUERY_TIMEOUT_SECONDS=1320      # SQLクエリ実行タイムアウト（22分）
API_TIMEOUT_SECONDS=1320        # API応答タイムアウト（22分）
```

### フロントエンド統合設定

#### CORS 設定

```bash
# 許可するオリジン（カンマ区切り）
CORS_ORIGINS=http://localhost:5173,http://127.0.0.1:5173
```

#### 履歴管理設定

```bash
# SQL実行履歴の保持設定
MAX_HISTORY_LOGS=1000  # 保持する履歴の最大件数
```

### マスターデータ・スケジューラー設定

#### マスターデータ更新設定

```bash
# マスターデータ更新スケジューラー
SCHEDULER_ENABLED=true                    # スケジューラー機能の有効化
MASTER_DATA_AUTO_UPDATE_ENABLED=true     # マスターデータ自動更新の有効化
MASTER_DATA_UPDATE_CRON="0 2 * * 0"      # 毎週日曜日2時に実行
MASTER_DATA_BATCH_SIZE=1000               # バッチ処理サイズ
```

#### マスター検索設定

```bash
# マスターデータ検索制限（製造ライン設備・測定値マスター）
MAX_MASTER_SEARCH_RESULTS=1000            # 検索結果の最大件数
MASTER_SEARCH_CACHE_TTL_HOURS=24          # 検索結果キャッシュ有効期限（時間）
STATION_MASTER_ENABLED=true               # 設備マスター機能の有効化
MEASURE_MASTER_ENABLED=true               # 測定値マスター機能の有効化
```

### 環境変数の優先順位

1. システム環境変数
2. `.env`ファイル
3. `env.example`のデフォルト値

### セキュリティ考慮事項

- **SECRET_KEY**: 本番環境では十分に長く（32 文字以上）ランダムな値を設定
- **ADMIN_PASSWORD**: 強力なパスワードを設定し、定期的に変更
- **データベース認証情報**: 最小権限の原則に従ってアカウントを設定
- **CORS_ORIGINS**: 本番環境では具体的なドメインを指定し、ワイルドカード（\*）は避ける

## 🤝 コントリビューション

1. フィーチャーブランチを作成
2. 変更を実装
3. テストを追加・実行
4. プルリクエストを作成

## 📄 ライセンス

このプロジェクトは私的利用のためのものです。
