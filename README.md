# Snowsight 風 SQL Web アプリ

Snowflake データベース用の Web ベース SQL エディタです。Snowsight のような直感的なインターフェースで SQL クエリを実行し、結果を確認・エクスポートできます。

## 主な機能

- **SQL エディタ**: CodeMirror ベースの高機能 SQL エディタ
- **メタデータブラウザ**: スキーマ・テーブル・カラムの階層表示
- **クエリ実行**: リアルタイムでの SQL 実行と結果表示
- **データエクスポート**: CSV 形式での全件データエクスポート（BOM 付き UTF-8）
- **SQL バリデーション**: 構文チェックと自動整形
- **レスポンシブデザイン**: モバイル対応
- **サイドバー幅調整**: ドラッグでサイドバーの幅を変更可能
- **エディタ高さ調整**: ドラッグで SQL エディタと結果表示エリアの高さを調整可能
- **メタデータキャッシュ**: SQLite によるサーバーサイドキャッシュで高速表示
- **接続状態表示**: 実際のデータベース操作に応じた動的接続状態確認
- **Snowflake ステージ経由エクスポート**: 高速な CSV ファイル生成とダウンロード
- **キーペア認証**: セキュアな Snowflake 接続

## 技術スタック

### バックエンド

- **FastAPI**: 高速な Web フレームワーク
- **Snowflake Connector**: Snowflake 接続（キーペア認証）
- **SQLite**: メタデータキャッシュ用
- **Pydantic**: データバリデーション
- **httpx**: 非同期 HTTP クライアント（プリサインド URL 取得用）

### フロントエンド

- **Bootstrap 5**: レスポンシブ UI
- **CodeMirror**: SQL エディタ
- **Chart.js**: グラフ表示
- **Font Awesome**: アイコン

## セットアップ

### 前提条件

- Python 3.8 以上
- Snowflake アカウント
- 必要な権限を持つ Snowflake ユーザー
- **キーペア認証用の秘密鍵ファイル（PEM 形式）**

### キーペア認証の準備

1. **秘密鍵の生成**（まだ作成していない場合）

   ```bash
   # OpenSSLを使用して秘密鍵を生成
   openssl genrsa -aes256 -out rsa_key.pem 2048

   # 公開鍵を生成
   openssl rsa -in rsa_key.pem -pubout -out rsa_key.pub
   ```

2. **Snowflake での設定**
   ```sql
   -- Snowflakeで公開鍵を登録
   ALTER USER your_username SET RSA_PUBLIC_KEY='-----BEGIN PUBLIC KEY-----
   MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...
   -----END PUBLIC KEY-----';
   ```

### インストール

1. リポジトリをクローン

```bash
git clone <repository-url>
cd SQLdojo
```

2. 依存関係をインストール

```bash
pip install -r requirements.txt
```

3. 環境変数を設定

```bash
# .envファイルを作成
SNOWFLAKE_ACCOUNT=your-account.snowflakecomputing.com
SNOWFLAKE_USER=your_username
SNOWFLAKE_PRIVATE_KEY_PATH=/path/to/your/private_key.pem
SNOWFLAKE_PRIVATE_KEY_PASSPHRASE=your_passphrase
SNOWFLAKE_WAREHOUSE=COMPUTE_WH
SNOWFLAKE_DATABASE=your_database
SNOWFLAKE_SCHEMA=PUBLIC
SNOWFLAKE_ROLE=your_role

# アプリケーション設定
APP_HOST=0.0.0.0
APP_PORT=8000
APP_DEBUG=false

# ログ設定
LOG_LEVEL=INFO
```

**重要**:

- `SNOWFLAKE_PRIVATE_KEY_PATH`: 秘密鍵ファイルの絶対パスまたはプロジェクトからの相対パス
- `SNOWFLAKE_PRIVATE_KEY_PASSPHRASE`: 秘密鍵のパスフレーズ（設定していない場合は空文字列）

4. アプリケーションを起動

```bash
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

5. ブラウザでアクセス

```
http://localhost:8000
```

## 使用方法

### 基本的な SQL 実行

1. 左側のサイドバーからスキーマ・テーブルを選択
2. SQL エディタにクエリを入力
3. 「実行」ボタンをクリックまたは `Ctrl+Enter` で実行
4. 結果が右側のテーブルに表示されます

### メタデータの利用

- **スキーマ一覧**: 利用可能なスキーマを表示
- **テーブル一覧**: 選択したスキーマ内のテーブルを表示
- **カラム情報**: テーブルのカラム詳細を表示
- **メタデータキャッシュ**: 高速表示のためのローカルキャッシュ

### データエクスポート

1. SQL クエリを実行
2. 結果ヘッダーの「CSV」ボタンをクリック
3. 全件データが自動的にエクスポートされます（表示制限なし）
4. BOM 付き UTF-8 形式で Excel でも正しく表示されます

### キーボードショートカット

- `Ctrl+Enter`: SQL 実行
- `Ctrl+Shift+F`: SQL 整形
- `Ctrl+L`: SQL クリア
- `Ctrl+Shift+V`: SQL バリデーション
- `F11`: 全画面切り替え
- `F1`: ショートカット一覧表示

## 技術的改善点

### 1. メタデータキャッシュシステム

- **SQLite キャッシュ**: メタデータを `metadata_cache.db` に永続化
- Snowflake への不要なアクセスを劇的に削減
- 表示速度の向上と API コストの抑制を実現

### 2. API の簡素化

- 一括メタデータ取得 API（`/api/v1/metadata/all`）
- 強制更新 API（`/api/v1/metadata/refresh`）
- 不要な個別 API の削除

### 3. 接続管理の最適化

- **能動的接続テストの廃止**: `SELECT 1 as test` クエリを削除
- **接続プール状態監視**: 実際のクエリ実行に基づく接続状態判断
- **負荷軽減**: 不要なデータベースアクセスの削減

### 4. 全件データエクスポート

- **Snowflake ステージ経由エクスポート**: 高速な CSV ファイル生成
- **BOM 付き UTF-8**: Excel でも正しく表示される文字エンコーディング
- **ストリーミング対応**: 大容量データでもメモリ効率的に処理
- **制限なし**: 5000 行制限を超える全データをエクスポート可能

### 5. UI/UX 改善

- **フロントエンド改善**

  - LocalStorage キャッシュの廃止
  - イベントリスナー管理の改善
  - リサイザー機能の一元化
  - Excel 出力機能の削除（CSV に統一）

- **バックエンド改善**
  - 接続状態 API の改善
  - 非同期処理の最適化
  - エラーハンドリングの強化

### 6. パフォーマンス最適化

- **キャッシュ戦略**: メタデータの効率的なキャッシュ
- **接続プール**: データベース接続の再利用
- **非同期処理**: 重い処理の非同期実行
- **ストリーミング**: 大容量データの効率的な処理

### 7. 設定管理の簡素化（v1.3.0）

- **複雑な階層構造の削除**: 4 つの設定クラスを 1 つのシンプルなクラスに統合
- **不要な設定項目の削除**: 実際に使用されていない設定を削除
- **環境変数名の統一**: 設定クラスのフィールド名と環境変数名を一致
- **後方互換性の維持**: 既存のコードが動作するようエイリアス関数を提供
- **設定の検証強化**: Pydantic による自動バリデーション
- **キーペア認証専用**: セキュアな認証方式に統一

## 今後のリファクタリング計画

### 高優先度（技術的負債の解消）

1. **✅ 設定管理の簡素化（完了）**

   - `config.py`の複雑な階層構造を簡素化
   - 不要な設定項目の削除
   - 環境変数ベースの設定に統一
   - キーペア認証専用に統一

2. **依存性注入の改善**

   - `container.py`の複雑なサービス管理を簡素化
   - 不要なシングルトンパターンの削除
   - より軽量な DI コンテナへの移行

3. **ログシステムの最適化**
   - `logger.py`の過度に複雑な機能を簡素化
   - パフォーマンス監視の分離
   - 標準的な Python ログ設定への移行

### 中優先度（機能改善）

4. **エラーハンドリングの統一**

   - 例外クラスの整理
   - エラーメッセージの標準化
   - フロントエンド・バックエンド間のエラー連携改善

5. **テストカバレッジの向上**

   - 統合テストの追加
   - モックを使用した単体テストの改善
   - エンドツーエンドテストの追加

6. **セキュリティ強化**
   - SQL インジェクション対策の強化
   - 入力値検証の改善
   - セッション管理の改善

### 低優先度（将来の拡張）

7. **マイクロサービス化の準備**

   - サービス間の疎結合化
   - API 設計の標準化
   - データベース接続の分離

8. **監視・運用の改善**
   - メトリクス収集の強化
   - アラート機能の追加
   - ログ分析の改善

## アーキテクチャ

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   フロントエンド   │    │    FastAPI      │    │    Snowflake    │
│                 │    │                 │    │                 │
│ - Bootstrap 5   │◄──►│ - API Routes    │◄──►│ - データベース    │
│ - CodeMirror    │    │ - Services      │    │ - メタデータ      │
│ - JavaScript    │    │ - SQLite Cache  │    │ - クエリ実行      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │
                              ▼
                       ┌─────────────────┐
                       │   Snowflake     │
                       │   Stage         │
                       │   (CSV Export)  │
                       └─────────────────┘
```

## 開発

### プロジェクト構造

```
SQLdojo/
├── app/
│   ├── api/              # API定義
│   │   ├── models.py     # データモデル
│   │   ├── routes.py     # APIルート
│   │   └── error_handlers.py # エラーハンドラー
│   ├── services/         # ビジネスロジック
│   │   ├── connection_manager.py # 接続管理（キーペア認証）
│   │   ├── database_service.py   # データベースサービス
│   │   ├── export_service.py     # エクスポートサービス
│   │   ├── metadata_service.py   # メタデータサービス
│   │   ├── performance_service.py # パフォーマンスサービス
│   │   ├── query_executor.py     # クエリ実行
│   │   └── sql_service.py        # SQLサービス
│   ├── static/           # 静的ファイル
│   │   ├── css/          # スタイルシート
│   │   └── js/           # JavaScript
│   ├── templates/        # HTMLテンプレート
│   ├── config_simplified.py # 簡素化された設定管理（キーペア認証専用）
│   ├── config.py         # 旧設定管理（後方互換性）
│   ├── container.py      # 依存性注入
│   ├── exceptions.py     # 例外定義
│   ├── logger.py         # ログ設定
│   ├── main.py           # アプリケーションエントリ
│   ├── metadata_cache.py # メタデータキャッシュ
│   ├── sql_validator.py  # SQLバリデーション
│   └── utils.py          # ユーティリティ
├── metadata_cache.db     # メタデータキャッシュDB
├── requirements.txt      # 依存関係
├── env.example.simplified # キーペア認証用環境変数設定例
├── env.example           # 旧環境変数設定例
└── README.md            # このファイル
```

### テスト

```bash
# 新しい設定のテスト
python test_config_simplified.py

# 全テストの実行
python run_tests.py
```

### ログ

アプリケーションログは以下の場所で確認できます：

- コンソール出力
- `app.log` ファイル

## トラブルシューティング

### よくある問題

1. **キーペア認証エラー**

   - 秘密鍵ファイルのパスが正しいか確認
   - パスフレーズが正しいか確認
   - 秘密鍵ファイルの権限が適切か確認

2. **接続エラー**

   - Snowflake アカウント名が正しいか確認
   - ユーザーに適切な権限があるか確認
   - ネットワーク接続が正常か確認

3. **メタデータ取得エラー**
   - キャッシュをクリアしてみる
   - データベースへの接続を確認

## ライセンス

MIT License

## 貢献

プルリクエストやイシューの報告を歓迎します。

## 更新履歴

### v1.3.0 (2025-01-XX)

- **設定管理の大幅簡素化**
  - 複雑な階層構造（4 つの設定クラス）を 1 つのシンプルなクラスに統合
  - 不要な設定項目の削除（セキュリティ設定、詳細なログ設定など）
  - 環境変数名の統一と簡素化
  - 後方互換性のためのエイリアス関数を提供
  - Pydantic による自動バリデーション強化
  - **キーペア認証専用に統一**（パスワード認証を削除）
- **依存性注入の簡素化**
  - 複雑なシングルトンパターンの削除
  - 不要なファクトリー機能の削除
  - より軽量で理解しやすいコンテナ構造
- **ログシステムの最適化**
  - 過度に複雑なパフォーマンス監視機能の簡素化
  - 標準的な Python ログ設定への移行
  - ファイルハンドラーの簡素化

### v1.2.0 (2025-01-XX)

- **CSV エクスポート機能の大幅改善**
  - Snowflake ステージ経由の高速エクスポート
  - BOM 付き UTF-8 形式で Excel 互換性を確保
  - ストリーミング対応で大容量データ処理
  - 文字化け問題の完全解決
- **Excel 出力機能の削除**
  - UI から Excel 出力ボタンを削除
  - バックエンドから Excel 関連処理を削除
  - CSV 出力に機能を統一
- **エラーハンドリングの改善**
  - 不要な zlib 処理の削除
  - ストリーミング処理の安定化
  - サーバークラッシュ問題の解決

### v1.1.0 (2025-06-21)

- SQLite メタデータキャッシュシステム
- 全件データエクスポート機能
- 接続管理の最適化
- UI/UX 改善
- パフォーマンス最適化

### v1.0.0 (2025-06-21)

- 初期リリース
- 基本的な SQL エディタ機能
- メタデータブラウザ
- データエクスポート機能
