# gemini 協議事項

## 現在の状況

- SQLdojo: FastAPI + Bootstrap 5 + CodeMirror を使用した SQL Web アプリケーション
- 既存のテンプレート・パーツ機能：個人用と共通用のテンプレート/パーツ管理が存在
- 現在のデータ構造：`user_templates`, `admin_templates`等のテーブルが存在

## 改善要求

### 1. 表示と並び替え

- ユーザーページで個人用と共通用のテンプレート/パーツを統合リストで表示
- 各項目に「個人」「共通」のラベル表示
- ↑↓ ボタンで自由な並び替え（個人用・共通用の垣根を越えて）
- 並び替えた順序はユーザーごとに保存・維持
- メイン画面のドロップダウンは並び替えた順序で表示

### 2. 表示/非表示の切り替え

- 各項目にチェックボックス設置
- チェック ON：メイン画面のドロップダウンに表示
- チェック OFF：メイン画面から非表示（ユーザーページには残る）

### 3. 編集機能

- 各項目に「編集」ボタン設置
- クリックでフォームに転記、「保存」→「更新」に変化
- 更新処理と変更破棄確認の実装

### 4. データモデル変更

- 既存テーブルから display_order, is_visible カラム削除
- 新規テーブル（user_template_preferences, user_part_preferences）作成
- 実体と表示設定の完全分離

## ユーザーに確認すべき不足情報

1. 既存データの移行方針（既存の display_order をどう引き継ぐか）
2. デフォルト並び順の仕様（個人用が上、共通が下でよいか）
3. 共通テンプレートの編集権限（ユーザーは編集不可でよいか）
4. 削除された共通テンプレートの表示設定クリーンアップ方法

## 検討すべき改善点

1. **データベース設計**：

   - 新規テーブル設計の妥当性
   - 既存テーブルからのマイグレーション方法
   - インデックス設計とパフォーマンス最適化

2. **バックエンド API 設計**：

   - 統合リスト取得 API
   - 並び替え・表示設定の一括更新 API
   - 初回アクセス時のデフォルト設定生成

3. **フロントエンド UI 設計**：

   - 統合リストの表示方法
   - ドラッグ&ドロップ vs ↑↓ ボタン
   - 編集モードの実装方法

4. **パフォーマンス考慮**：
   - 大量データ（数百件のテンプレート）での動作
   - 並び替え処理の最適化
   - キャッシュ戦略

## 実装方針の検討

1. 新規テーブル作成とマイグレーション
2. バックエンド API 実装
3. フロントエンド統合リスト実装
4. 編集機能実装

## 依頼事項

実装方針に対して@cursor.md の開発憲章を準拠するための注意点を教えてください

特に以下の点について：

1. 高リスク変更としてのプロセス適用の妥当性
2. 段階的実装における各段階でのテスト戦略
3. 既存機能の保護方法
4. データベースマイグレーションの安全な実行方法
5. ユーザビリティ最優先の設計における具体的な注意点
